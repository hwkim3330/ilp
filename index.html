<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TSN TAS GCL JS Solver</title>
  <style>
    :root {
      --bg: #0a1022;
      --card: #141d36;
      --line: #2d3b64;
      --text: #edf2ff;
      --muted: #98a7ce;
      --accent: #64f6cb;
      --warn: #ff7d7d;
      --ok: #84f4a5;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 0% 0%, #1f2b56, var(--bg));
    }
    .wrap { max-width: 1200px; margin: 0 auto; }
    .card {
      background: linear-gradient(180deg, #1a2648, var(--card));
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-top: 12px;
    }
    h1 { margin: 0; font-size: 1.6rem; }
    p { color: var(--muted); margin: 8px 0 0; }
    textarea {
      width: 100%;
      min-height: 250px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #0e1630;
      color: var(--text);
      padding: 10px;
      font-family: "JetBrains Mono", "Consolas", monospace;
      font-size: 0.83rem;
      line-height: 1.5;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #0b1528;
      margin-right: 8px;
    }
    .btn.secondary { background: #4f648f; color: #fff; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .metric .v { font-size: 1.35rem; font-weight: 700; color: var(--accent); }
    .metric .k { color: var(--muted); font-size: 0.82rem; }
    .axis {
      margin-top: 10px;
      height: 22px;
      border: 1px dashed var(--line);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.02);
    }
    .tick { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.14); }
    .row { margin-top: 8px; border: 1px solid var(--line); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.12); }
    .row .t { color: var(--muted); font-size: 0.82rem; margin-bottom: 6px; }
    .bar-area { height: 30px; border-radius: 6px; background: rgba(255,255,255,0.03); position: relative; overflow: hidden; }
    .bar {
      position: absolute;
      top: 2px;
      height: 26px;
      border-radius: 5px;
      font-size: 0.72rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
      white-space: nowrap;
      color: #f8fbff;
    }
    .bar.flow { background: linear-gradient(90deg, #5ca7ff, #7f7fff); }
    .bar.guard { background: #ffb067; color: #111; }
    .bar.rem { background: #2d8c6b; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid var(--line); text-align: left; padding: 8px; font-size: 0.85rem; }
    th { color: var(--muted); font-weight: 500; }
    .ok { color: var(--ok); }
    .miss { color: var(--warn); }
    pre {
      margin: 0;
      white-space: pre-wrap;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: #0d1630;
      padding: 10px;
      font-size: 0.8rem;
      color: #c6d5ff;
    }
    #status { margin-top: 10px; font-size: 0.9rem; color: var(--muted); }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TSN/TAS/GCL JS Solver</h1>
    <p>브라우저에서 계산과 시각화를 같이 수행합니다. (설치 없음)</p>

    <div class="card">
      <strong>Input JSON</strong>
      <textarea id="input"></textarea>
      <div style="margin-top:10px;">
        <button class="btn" id="solveBtn">Solve (Exact Search)</button>
        <button class="btn secondary" id="resetBtn">Reset Sample</button>
      </div>
      <div id="status"></div>
    </div>

    <div class="grid">
      <div class="card metric"><div class="v" id="mCycle">-</div><div class="k">Cycle (us)</div></div>
      <div class="card metric"><div class="v" id="mJobs">-</div><div class="k">Jobs</div></div>
      <div class="card metric"><div class="v" id="mObj">-</div><div class="k">Objective (TSN end sum)</div></div>
      <div class="card metric"><div class="v" id="mUtil">-</div><div class="k">Utilization (%)</div></div>
    </div>

    <div class="card">
      <strong>GCL Timeline</strong>
      <div class="axis" id="axis"></div>
      <div style="display:flex;justify-content:space-between;color:#98a7ce;font-size:0.75rem;margin-top:4px;"><span>0</span><span id="axisMax">-</span></div>
      <div id="rows"></div>
    </div>

    <div class="card">
      <strong>Scheduled Jobs</strong>
      <table>
        <thead>
          <tr>
            <th>Job</th>
            <th>Flow</th>
            <th>Prio</th>
            <th>Release</th>
            <th>Start</th>
            <th>End</th>
            <th>Deadline</th>
            <th>Slack</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="jobTable"></tbody>
      </table>
    </div>

    <div class="card">
      <strong>Generated GCL JSON</strong>
      <pre id="gclOut">-</pre>
    </div>
  </div>

  <script>
    const sampleInput = {
      cycle_time_us: 1000,
      guard_band_us: 12.3,
      link_speed_mbps: 1000,
      keepout_after_tsn: true,
      flows: [
        { id: "f1", priority: 7, payload_bytes: 1024, period_us: 1000, deadline_us: 500, traffic_type: "control" },
        { id: "f2", priority: 7, payload_bytes: 512, period_us: 500, deadline_us: 280, traffic_type: "sensor" },
        { id: "f3", priority: 3, payload_bytes: 1200, period_us: 1000, deadline_us: null, traffic_type: "video" },
        { id: "f4", priority: 0, payload_bytes: 256, period_us: 1000, deadline_us: null, traffic_type: "be" }
      ]
    };

    const inputEl = document.getElementById("input");
    const statusEl = document.getElementById("status");
    const solveBtn = document.getElementById("solveBtn");
    const resetBtn = document.getElementById("resetBtn");

    resetSample();

    resetBtn.addEventListener("click", resetSample);
    solveBtn.addEventListener("click", () => {
      try {
        const model = JSON.parse(inputEl.value);
        const t0 = performance.now();
        const result = solveExact(model);
        const elapsed = (performance.now() - t0).toFixed(1);
        render(result);
        statusEl.textContent = `완료: nodes=${result.stats.nodes}, pruned=${result.stats.pruned}, time=${elapsed}ms`;
      } catch (err) {
        statusEl.innerHTML = `<span style=\"color:#ff9a9a\">오류: ${err.message}</span>`;
      }
    });

    function resetSample() {
      inputEl.value = JSON.stringify(sampleInput, null, 2);
      statusEl.textContent = "샘플 입력 로드됨";
    }

    function txTimeUs(payloadBytes, mbps) {
      return ((payloadBytes + 38) * 8) / mbps;
    }

    function isTsn(priority, deadline) {
      return priority >= 6 || deadline !== null;
    }

    function round3(v) {
      return Math.round(v * 1000) / 1000;
    }

    function expandJobs(model) {
      const jobs = [];
      for (const flow of model.flows) {
        if (!flow.period_us || flow.period_us <= 0) throw new Error(`invalid period_us: ${flow.id}`);
        const countRaw = model.cycle_time_us / flow.period_us;
        const count = Math.round(countRaw);
        if (Math.abs(countRaw - count) > 1e-9) {
          throw new Error(`cycle_time_us must be divisible by period_us (${flow.id})`);
        }
        for (let k = 0; k < count; k++) {
          const release = k * flow.period_us;
          jobs.push({
            job_id: `${flow.id}#${k}`,
            flow_id: flow.id,
            priority: flow.priority,
            traffic_type: flow.traffic_type,
            release_us: release,
            tx_us: txTimeUs(flow.payload_bytes, model.link_speed_mbps),
            deadline_us: flow.deadline_us == null ? null : release + flow.deadline_us,
            tsn: isTsn(flow.priority, flow.deadline_us)
          });
        }
      }
      return jobs;
    }

    function solveExact(model) {
      if (!model || !Array.isArray(model.flows) || model.flows.length === 0) {
        throw new Error("flows must not be empty");
      }
      if (model.link_speed_mbps <= 0) throw new Error("link_speed_mbps must be > 0");

      const jobs = expandJobs(model);
      const n = jobs.length;
      if (n > 12) {
        throw new Error(`jobs=${n} too large for exact search in browser (<=12 권장)`);
      }

      let bestObjective = Number.POSITIVE_INFINITY;
      let bestSchedule = null;
      let nodes = 0;
      let pruned = 0;

      const used = new Array(n).fill(false);
      const current = [];

      function dfs(depth, t, objective) {
        nodes++;

        if (objective >= bestObjective) {
          pruned++;
          return;
        }

        if (depth === n) {
          if (t <= model.cycle_time_us && objective < bestObjective) {
            bestObjective = objective;
            bestSchedule = current.map(x => ({ ...x }));
          }
          return;
        }

        const candidates = [];
        for (let i = 0; i < n; i++) {
          if (!used[i]) candidates.push(i);
        }

        candidates.sort((a, b) => {
          const da = jobs[a].deadline_us == null ? Number.POSITIVE_INFINITY : jobs[a].deadline_us;
          const db = jobs[b].deadline_us == null ? Number.POSITIVE_INFINITY : jobs[b].deadline_us;
          if (da !== db) return da - db;
          return jobs[b].priority - jobs[a].priority;
        });

        for (const i of candidates) {
          const job = jobs[i];
          const start = Math.max(t, job.release_us);
          const end = start + job.tx_us;

          if (end > model.cycle_time_us) {
            pruned++;
            continue;
          }
          if (job.deadline_us != null && end > job.deadline_us) {
            pruned++;
            continue;
          }

          const nextT = end + (model.keepout_after_tsn && job.tsn && depth < n - 1 ? model.guard_band_us : 0);
          if (nextT > model.cycle_time_us) {
            pruned++;
            continue;
          }

          used[i] = true;
          current.push({
            ...job,
            start_us: round3(start),
            end_us: round3(end),
            slack_us: job.deadline_us == null ? null : round3(job.deadline_us - end),
            status: job.deadline_us == null ? "BE" : "OK"
          });

          dfs(depth + 1, nextT, objective + (job.tsn ? end : 0));

          current.pop();
          used[i] = false;
        }
      }

      dfs(0, 0, 0);

      if (!bestSchedule) throw new Error("feasible schedule 없음 (deadline/cycle 제약 확인 필요)");

      const gcl = buildGcl(model, bestSchedule);
      const usedTime = gcl.entries[gcl.entries.length - 1].end_us;

      return {
        model,
        jobs: bestSchedule,
        gcl,
        objective: round3(bestObjective),
        utilization: round3((usedTime / model.cycle_time_us) * 100),
        stats: { nodes, pruned }
      };
    }

    function gateMask(priority) {
      const bits = Array(8).fill("0");
      const p = Math.min(7, Math.max(0, priority));
      bits[7 - p] = "1";
      return bits.join("");
    }

    function buildGcl(model, scheduledJobs) {
      const entries = [];
      let idx = 0;
      let lastEnd = 0;

      for (let i = 0; i < scheduledJobs.length; i++) {
        const j = scheduledJobs[i];
        entries.push({
          index: idx++,
          gate_mask: gateMask(j.priority),
          start_us: round3(j.start_us),
          duration_us: round3(j.end_us - j.start_us),
          end_us: round3(j.end_us),
          note: `${j.job_id} (${j.traffic_type})`
        });
        lastEnd = j.end_us;

        if (model.keepout_after_tsn && j.tsn && i < scheduledJobs.length - 1) {
          const gEnd = j.end_us + model.guard_band_us;
          entries.push({
            index: idx++,
            gate_mask: "00000000",
            start_us: round3(j.end_us),
            duration_us: round3(model.guard_band_us),
            end_us: round3(gEnd),
            note: "guard band"
          });
          lastEnd = gEnd;
        }
      }

      if (lastEnd < model.cycle_time_us) {
        entries.push({
          index: idx++,
          gate_mask: "00001111",
          start_us: round3(lastEnd),
          duration_us: round3(model.cycle_time_us - lastEnd),
          end_us: round3(model.cycle_time_us),
          note: "best-effort remainder"
        });
        lastEnd = model.cycle_time_us;
      }

      return {
        cycle_time_us: model.cycle_time_us,
        base_time_us: 0,
        entries,
        used_time_us: round3(lastEnd)
      };
    }

    function pct(v, max) {
      return max <= 0 ? 0 : (v / max) * 100;
    }

    function render(result) {
      document.getElementById("mCycle").textContent = round3(result.model.cycle_time_us);
      document.getElementById("mJobs").textContent = result.jobs.length;
      document.getElementById("mObj").textContent = result.objective;
      document.getElementById("mUtil").textContent = result.utilization;
      document.getElementById("axisMax").textContent = `${round3(result.model.cycle_time_us)} us`;

      const axis = document.getElementById("axis");
      axis.innerHTML = "";
      for (let i = 1; i < 10; i++) {
        const t = document.createElement("div");
        t.className = "tick";
        t.style.left = `${i * 10}%`;
        axis.appendChild(t);
      }

      const rows = document.getElementById("rows");
      rows.innerHTML = "";
      for (const e of result.gcl.entries) {
        const row = document.createElement("div");
        row.className = "row";
        const cls = e.note.includes("guard") ? "guard" : (e.note.includes("remainder") ? "rem" : "flow");
        row.innerHTML = `<div class="t">#${e.index} | mask=${e.gate_mask} | ${e.note}</div><div class="bar-area"><div class="bar ${cls}" style="left:${pct(e.start_us, result.model.cycle_time_us)}%;width:${Math.max(pct(e.duration_us, result.model.cycle_time_us), 0.8)}%">${e.start_us}-${e.end_us} us</div></div>`;
        rows.appendChild(row);
      }

      const tbody = document.getElementById("jobTable");
      tbody.innerHTML = "";
      for (const j of result.jobs) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${j.job_id}</td>
          <td>${j.flow_id}</td>
          <td>${j.priority}</td>
          <td>${round3(j.release_us)}</td>
          <td>${round3(j.start_us)}</td>
          <td>${round3(j.end_us)}</td>
          <td>${j.deadline_us == null ? "-" : round3(j.deadline_us)}</td>
          <td>${j.slack_us == null ? "-" : round3(j.slack_us)}</td>
          <td class="${j.status === "OK" || j.status === "BE" ? "ok" : "miss"}">${j.status}</td>`;
        tbody.appendChild(tr);
      }

      document.getElementById("gclOut").textContent = JSON.stringify(result.gcl, null, 2);
    }
  </script>
</body>
</html>
