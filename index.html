<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSN TAS ILP Scheduler Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #00d4ff;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .param {
            background: rgba(0,212,255,0.1);
            padding: 12px;
            border-radius: 8px;
        }
        .param label {
            display: block;
            font-size: 0.85em;
            color: #888;
            margin-bottom: 5px;
        }
        .param input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        .param .value {
            font-size: 1.2em;
            color: #00d4ff;
            font-weight: bold;
        }
        .param .unit {
            font-size: 0.8em;
            color: #888;
        }
        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.02);
        }
        .tas-timeline {
            background: #0a0a1a;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }
        .timeline-header {
            display: flex;
            margin-bottom: 10px;
            padding-left: 80px;
        }
        .time-marker {
            flex: 1;
            text-align: center;
            font-size: 0.75em;
            color: #666;
        }
        .queue-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .queue-label {
            width: 80px;
            font-size: 0.85em;
            color: #888;
        }
        .queue-slots {
            flex: 1;
            display: flex;
            height: 30px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            overflow: hidden;
        }
        .slot {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            transition: all 0.3s;
        }
        .slot.active {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
        }
        .slot.tsn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        }
        .slot.be {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }
        .slot:hover {
            filter: brightness(1.2);
        }
        .ilp-result {
            background: rgba(0,212,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .ilp-equation {
            font-family: 'Courier New', monospace;
            background: #0a0a1a;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.8;
        }
        .highlight {
            color: #00d4ff;
        }
        .constraint {
            color: #ff6b6b;
        }
        .variable {
            color: #4ecdc4;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        .metric .value {
            font-size: 1.8em;
            color: #00d4ff;
            font-weight: bold;
        }
        .metric .label {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        .flow-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .flow-table th, .flow-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .flow-table th {
            color: #00d4ff;
            font-weight: normal;
            font-size: 0.85em;
        }
        .flow-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .priority-7 {
            color: #ff6b6b;
            font-weight: bold;
        }
        .status-scheduled {
            color: #4ecdc4;
        }
        canvas {
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TSN TAS ILP Scheduler</h1>
        <p class="subtitle">Time-Aware Shaper Gate Control List Optimization using Integer Linear Programming</p>

        <div class="grid">
            <!-- QoS Parameters -->
            <div class="card">
                <h2>QoS Parameters (Time-Sensitive Topic)</h2>
                <div class="param-grid">
                    <div class="param">
                        <label>LatencyBudgetQoS</label>
                        <input type="number" id="latencyBudget" value="500">
                        <span class="unit">µs</span>
                    </div>
                    <div class="param">
                        <label>TransportPriorityQoS</label>
                        <input type="number" id="transportPriority" value="7" min="0" max="7">
                    </div>
                    <div class="param">
                        <label>PayloadQoS</label>
                        <input type="number" id="payload" value="1024">
                        <span class="unit">Bytes</span>
                    </div>
                    <div class="param">
                        <label>Link Speed</label>
                        <input type="number" id="linkSpeed" value="1000">
                        <span class="unit">Mbps</span>
                    </div>
                </div>
                <div class="param-grid" style="margin-top: 10px;">
                    <div class="param">
                        <label>TimeAwareQoS - Earliest</label>
                        <input type="number" id="earliest" value="0">
                        <span class="unit">µs</span>
                    </div>
                    <div class="param">
                        <label>TimeAwareQoS - Latest</label>
                        <input type="number" id="latest" value="1000">
                        <span class="unit">µs</span>
                    </div>
                    <div class="param">
                        <label>TimeAwareQoS - Jitter</label>
                        <input type="number" id="jitter" value="100">
                        <span class="unit">µs</span>
                    </div>
                    <div class="param">
                        <label>Cycle Time</label>
                        <input type="number" id="cycleTime" value="1000">
                        <span class="unit">µs</span>
                    </div>
                </div>
                <button onclick="calculateILP()">Calculate ILP Schedule</button>
            </div>

            <!-- ILP Formulation -->
            <div class="card">
                <h2>ILP Formulation</h2>
                <div class="ilp-equation" id="ilpFormulation">
                    <div><span class="highlight">Minimize:</span> Σ (slot_end[i] - slot_start[i]) for BE traffic</div>
                    <br>
                    <div><span class="highlight">Subject to:</span></div>
                    <div class="constraint">  ∀ TSN flow f:</div>
                    <div>    <span class="variable">tx_time[f]</span> ≥ earliest[f]</div>
                    <div>    <span class="variable">tx_time[f]</span> + <span class="variable">duration[f]</span> ≤ latest[f]</div>
                    <div>    <span class="variable">duration[f]</span> = payload[f] / link_speed</div>
                    <br>
                    <div class="constraint">  No overlap constraint:</div>
                    <div>    <span class="variable">tx_time[i]</span> + <span class="variable">duration[i]</span> ≤ <span class="variable">tx_time[j]</span></div>
                    <div>    OR <span class="variable">tx_time[j]</span> + <span class="variable">duration[j]</span> ≤ <span class="variable">tx_time[i]</span></div>
                    <br>
                    <div class="constraint">  Jitter constraint:</div>
                    <div>    |<span class="variable">tx_time[f]</span> - <span class="variable">expected[f]</span>| ≤ jitter[f]</div>
                </div>
            </div>
        </div>

        <!-- TAS Timeline Visualization -->
        <div class="card">
            <h2>TAS Gate Control List (GCL) Timeline</h2>
            <div class="tas-timeline">
                <div class="timeline-header" id="timelineHeader"></div>
                <div id="queueRows"></div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a);"></div>
                    <span>TSN Traffic (Priority 7)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(135deg, #4ecdc4, #44a08d);"></div>
                    <span>Best Effort Traffic</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(255,255,255,0.1);"></div>
                    <span>Guard Band / Idle</span>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Scheduled Flows -->
            <div class="card">
                <h2>Scheduled Flows</h2>
                <table class="flow-table">
                    <thead>
                        <tr>
                            <th>Flow ID</th>
                            <th>Priority</th>
                            <th>Payload</th>
                            <th>TX Start</th>
                            <th>TX End</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="flowTable"></tbody>
                </table>
            </div>

            <!-- Metrics -->
            <div class="card">
                <h2>Schedule Metrics</h2>
                <div class="metrics">
                    <div class="metric">
                        <div class="value" id="metricUtilization">-</div>
                        <div class="label">Link Utilization</div>
                    </div>
                    <div class="metric">
                        <div class="value" id="metricTsnSlots">-</div>
                        <div class="label">TSN Slots</div>
                    </div>
                    <div class="metric">
                        <div class="value" id="metricBeSlots">-</div>
                        <div class="label">BE Slots</div>
                    </div>
                    <div class="metric">
                        <div class="value" id="metricGuardBand">-</div>
                        <div class="label">Guard Band</div>
                    </div>
                </div>
                <canvas id="utilizationChart" style="margin-top: 20px;"></canvas>
            </div>
        </div>

        <!-- Latency Analysis -->
        <div class="card">
            <h2>Latency Analysis</h2>
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <script>
        let utilizationChart = null;
        let latencyChart = null;

        function calculateTransmissionTime(payloadBytes, linkSpeedMbps) {
            // Ethernet overhead: 8 preamble + 14 header + 4 FCS + 12 IFG = 38 bytes
            const overhead = 38;
            const totalBytes = payloadBytes + overhead;
            const bits = totalBytes * 8;
            const timeUs = bits / linkSpeedMbps;
            return timeUs;
        }

        function calculateILP() {
            const latencyBudget = parseFloat(document.getElementById('latencyBudget').value);
            const priority = parseInt(document.getElementById('transportPriority').value);
            const payload = parseInt(document.getElementById('payload').value);
            const linkSpeed = parseInt(document.getElementById('linkSpeed').value);
            const earliest = parseFloat(document.getElementById('earliest').value);
            const latest = parseFloat(document.getElementById('latest').value);
            const jitter = parseFloat(document.getElementById('jitter').value);
            const cycleTime = parseFloat(document.getElementById('cycleTime').value);

            // Calculate transmission duration
            const txDuration = calculateTransmissionTime(payload, linkSpeed);

            // Guard band (typically one max frame)
            const guardBand = calculateTransmissionTime(1522, linkSpeed); // Max Ethernet frame

            // Generate TSN flows (Priority 7 only gets dedicated slots)
            const flows = [];

            // Main TSN flow
            flows.push({
                id: 'TSN-1',
                priority: 7,
                payload: payload,
                txStart: earliest,
                txEnd: earliest + txDuration,
                type: 'tsn',
                status: 'scheduled'
            });

            // Add some example BE flows
            const beStart = earliest + txDuration + guardBand;
            flows.push({
                id: 'BE-1',
                priority: 0,
                payload: 512,
                txStart: beStart,
                txEnd: beStart + calculateTransmissionTime(512, linkSpeed),
                type: 'be',
                status: 'scheduled'
            });

            flows.push({
                id: 'BE-2',
                priority: 1,
                payload: 256,
                txStart: flows[1].txEnd + 5,
                txEnd: flows[1].txEnd + 5 + calculateTransmissionTime(256, linkSpeed),
                type: 'be',
                status: 'scheduled'
            });

            // Update timeline visualization
            renderTimeline(flows, cycleTime, guardBand);

            // Update flow table
            renderFlowTable(flows);

            // Update metrics
            updateMetrics(flows, cycleTime, guardBand, txDuration);

            // Update charts
            updateCharts(flows, latencyBudget, cycleTime);
        }

        function renderTimeline(flows, cycleTime, guardBand) {
            const header = document.getElementById('timelineHeader');
            const rows = document.getElementById('queueRows');

            // Time markers
            const numMarkers = 10;
            header.innerHTML = '';
            for (let i = 0; i <= numMarkers; i++) {
                const time = (cycleTime * i / numMarkers).toFixed(0);
                header.innerHTML += `<div class="time-marker">${time}µs</div>`;
            }

            // Queue rows (8 queues for TSN)
            rows.innerHTML = '';
            for (let q = 7; q >= 0; q--) {
                const queueFlows = flows.filter(f => f.priority === q);

                let slotsHtml = '';
                let currentPos = 0;

                queueFlows.forEach(f => {
                    // Gap before this flow
                    if (f.txStart > currentPos) {
                        const gapWidth = ((f.txStart - currentPos) / cycleTime * 100);
                        slotsHtml += `<div class="slot" style="width: ${gapWidth}%"></div>`;
                    }

                    // The flow itself
                    const flowWidth = ((f.txEnd - f.txStart) / cycleTime * 100);
                    const flowClass = f.type === 'tsn' ? 'tsn' : 'be';
                    slotsHtml += `<div class="slot active ${flowClass}" style="width: ${flowWidth}%" title="${f.id}: ${f.txStart.toFixed(1)}-${f.txEnd.toFixed(1)}µs">${f.id}</div>`;

                    currentPos = f.txEnd;
                });

                // Fill remaining
                if (currentPos < cycleTime) {
                    const remainWidth = ((cycleTime - currentPos) / cycleTime * 100);
                    slotsHtml += `<div class="slot" style="width: ${remainWidth}%"></div>`;
                }

                rows.innerHTML += `
                    <div class="queue-row">
                        <div class="queue-label">Queue ${q} ${q === 7 ? '(TSN)' : ''}</div>
                        <div class="queue-slots">${slotsHtml}</div>
                    </div>
                `;
            }
        }

        function renderFlowTable(flows) {
            const tbody = document.getElementById('flowTable');
            tbody.innerHTML = flows.map(f => `
                <tr>
                    <td>${f.id}</td>
                    <td class="${f.priority === 7 ? 'priority-7' : ''}">${f.priority}</td>
                    <td>${f.payload} B</td>
                    <td>${f.txStart.toFixed(2)} µs</td>
                    <td>${f.txEnd.toFixed(2)} µs</td>
                    <td class="status-scheduled">${f.status}</td>
                </tr>
            `).join('');
        }

        function updateMetrics(flows, cycleTime, guardBand, tsnDuration) {
            const tsnFlows = flows.filter(f => f.type === 'tsn');
            const beFlows = flows.filter(f => f.type === 'be');

            const tsnTime = tsnFlows.reduce((sum, f) => sum + (f.txEnd - f.txStart), 0);
            const beTime = beFlows.reduce((sum, f) => sum + (f.txEnd - f.txStart), 0);
            const totalTime = tsnTime + beTime;
            const utilization = (totalTime / cycleTime * 100).toFixed(1);

            document.getElementById('metricUtilization').textContent = utilization + '%';
            document.getElementById('metricTsnSlots').textContent = tsnFlows.length;
            document.getElementById('metricBeSlots').textContent = beFlows.length;
            document.getElementById('metricGuardBand').textContent = guardBand.toFixed(1) + 'µs';
        }

        function updateCharts(flows, latencyBudget, cycleTime) {
            // Utilization Chart
            const ctx1 = document.getElementById('utilizationChart').getContext('2d');

            if (utilizationChart) {
                utilizationChart.destroy();
            }

            const tsnTime = flows.filter(f => f.type === 'tsn').reduce((sum, f) => sum + (f.txEnd - f.txStart), 0);
            const beTime = flows.filter(f => f.type === 'be').reduce((sum, f) => sum + (f.txEnd - f.txStart), 0);
            const idleTime = cycleTime - tsnTime - beTime;

            utilizationChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['TSN Traffic', 'BE Traffic', 'Idle/Guard'],
                    datasets: [{
                        data: [tsnTime, beTime, idleTime],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#333'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#888' }
                        }
                    }
                }
            });

            // Latency Chart
            const ctx2 = document.getElementById('latencyChart').getContext('2d');

            if (latencyChart) {
                latencyChart.destroy();
            }

            const latencyData = flows.map(f => ({
                x: f.id,
                y: f.txEnd - f.txStart
            }));

            latencyChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: flows.map(f => f.id),
                    datasets: [
                        {
                            label: 'Transmission Time (µs)',
                            data: flows.map(f => f.txEnd - f.txStart),
                            backgroundColor: flows.map(f => f.type === 'tsn' ? '#ff6b6b' : '#4ecdc4'),
                            borderRadius: 5
                        },
                        {
                            label: 'Latency Budget',
                            data: flows.map(() => latencyBudget),
                            type: 'line',
                            borderColor: '#ffcc00',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: '#888' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#888' }
                        }
                    }
                }
            });
        }

        // Initial calculation
        window.onload = calculateILP;
    </script>
</body>
</html>
