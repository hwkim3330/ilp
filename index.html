<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TSN GCL ILP (Triangle 3-Switch)</title>
  <style>
    :root {
      --bg: #0a1124;
      --card: #131d3a;
      --line: #2c3a64;
      --text: #ecf2ff;
      --muted: #98a8d1;
      --accent: #63f4c9;
      --ok: #89f5a9;
      --warn: #ff8686;
      --flow: #5ca8ff;
      --guard: #ffb36e;
      --remain: #2d8f6e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 18px;
      font-family: "Pretendard", "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at 0% 0%, #1e2c58, var(--bg));
      color: var(--text);
    }
    .wrap { max-width: 1300px; margin: 0 auto; }
    .card {
      margin-top: 12px;
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: linear-gradient(180deg, #19274c, var(--card));
    }
    h1 { margin: 0; font-size: 1.5rem; }
    p { margin: 6px 0 0; color: var(--muted); }
    textarea {
      width: 100%;
      min-height: 300px;
      resize: vertical;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0d1633;
      color: var(--text);
      padding: 10px;
      font-family: "JetBrains Mono", "Consolas", monospace;
      font-size: 0.8rem;
      line-height: 1.45;
    }
    .toolbar {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
      background: var(--accent);
      color: #0e1a35;
    }
    .btn.secondary { background: #4b5f8a; color: #fff; }
    #status { margin-top: 8px; color: var(--muted); font-size: 0.9rem; }

    .grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    .metric .v { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
    .metric .k { color: var(--muted); font-size: 0.82rem; }

    .topo {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
      align-items: center;
      justify-items: center;
    }
    .node {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 12px;
      background: #0f1732;
      font-size: 0.82rem;
    }
    .node.switch { border-color: #6aa7ff; }
    .node.endstation { border-color: #61e2b9; }
    .edge {
      color: var(--muted);
      font-size: 0.8rem;
      border: 1px dashed var(--line);
      border-radius: 8px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.02);
    }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid var(--line); text-align: left; padding: 7px; font-size: 0.82rem; }
    th { color: var(--muted); font-weight: 500; }

    .axis {
      margin-top: 8px;
      height: 22px;
      border: 1px dashed var(--line);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
    }
    .tick { position: absolute; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.14); }
    .row { margin-top: 8px; border: 1px solid var(--line); border-radius: 8px; padding: 8px; background: rgba(0,0,0,0.12); }
    .row .title { color: var(--muted); font-size: 0.82rem; margin-bottom: 6px; }
    .bar-area { position: relative; height: 30px; border-radius: 6px; overflow: hidden; background: rgba(255,255,255,0.03); }
    .bar {
      position: absolute;
      top: 2px;
      height: 26px;
      border-radius: 5px;
      padding: 0 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      white-space: nowrap;
      color: #f7fbff;
    }
    .bar.flow { background: linear-gradient(90deg, #5ca8ff, #7f7fff); }
    .bar.guard { background: var(--guard); color: #151515; }
    .bar.remain { background: var(--remain); }

    .ok { color: var(--ok); }
    .miss { color: var(--warn); }
    pre {
      margin: 0;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #0d1630;
      padding: 10px;
      color: #c8d6ff;
      font-size: 0.8rem;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    @media (max-width: 980px) { .grid4 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 700px) {
      .grid4 { grid-template-columns: 1fr; }
      .topo { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TSN/TAS/GCL ILP Solver (3-Switch Triangle)</h1>
    <p>백엔드 Node + GLPK로 ILP 최적해를 계산하고, 링크별 GCL과 패킷 지연을 시각화합니다.</p>

    <div class="card">
      <strong>Input JSON</strong>
      <textarea id="input"></textarea>
      <div class="toolbar">
        <button id="renderBtn" class="btn secondary">Render Input</button>
        <button id="solveBtn" class="btn">Solve ILP</button>
        <button id="sampleBtn" class="btn secondary">Load Triangle Sample</button>
      </div>
      <div id="status"></div>
    </div>

    <div class="card">
      <strong>Topology (Triangle)</strong>
      <div id="topo" class="topo"></div>
      <div class="grid4" style="margin-top:8px;">
        <div class="card metric" style="margin-top:0;"><div class="v" id="inNodes">-</div><div class="k">Nodes</div></div>
        <div class="card metric" style="margin-top:0;"><div class="v" id="inLinks">-</div><div class="k">Links</div></div>
        <div class="card metric" style="margin-top:0;"><div class="v" id="inFlows">-</div><div class="k">Flows</div></div>
        <div class="card metric" style="margin-top:0;"><div class="v" id="inPkts">-</div><div class="k">Packets/Cycle</div></div>
      </div>
    </div>

    <div class="grid4">
      <div class="card metric"><div class="v" id="mMethod">-</div><div class="k">Solver</div></div>
      <div class="card metric"><div class="v" id="mObj">-</div><div class="k">Objective (TSN delay sum)</div></div>
      <div class="card metric"><div class="v" id="mUtil">-</div><div class="k">Worst Link Util (%)</div></div>
      <div class="card metric"><div class="v" id="mRuntime">-</div><div class="k">Runtime (ms)</div></div>
    </div>

    <div class="card">
      <strong>Per-Link GCL Timeline</strong>
      <div class="axis" id="axis"></div>
      <div style="display:flex;justify-content:space-between;color:#98a8d1;font-size:0.75rem;margin-top:4px;"><span>0</span><span id="axisMax">-</span></div>
      <div id="gclRows"></div>
    </div>

    <div class="card">
      <strong>Packet Result</strong>
      <table>
        <thead>
          <tr>
            <th>Packet</th><th>Flow</th><th>Release</th><th>End</th><th>E2E Delay</th><th>Deadline</th><th>Slack</th><th>Status</th>
          </tr>
        </thead>
        <tbody id="packetTable"></tbody>
      </table>
    </div>

    <div class="card">
      <strong>GCL JSON</strong>
      <pre id="jsonOut">-</pre>
    </div>
  </div>

  <script>
    const sample = {
      cycle_time_us: 1000,
      guard_band_us: 2,
      processing_delay_us: 2,
      nodes: [
        { id: "esA", type: "endstation" },
        { id: "esB", type: "endstation" },
        { id: "esC", type: "endstation" },
        { id: "s1", type: "switch" },
        { id: "s2", type: "switch" },
        { id: "s3", type: "switch" }
      ],
      links: [
        { id: "l_esA_s1", from: "esA", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
        { id: "l_s1_s2", from: "s1", to: "s2", rate_mbps: 1000, prop_delay_us: 0.8 },
        { id: "l_s2_s3", from: "s2", to: "s3", rate_mbps: 1000, prop_delay_us: 0.8 },
        { id: "l_s3_s1", from: "s3", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
        { id: "l_s2_esB", from: "s2", to: "esB", rate_mbps: 1000, prop_delay_us: 0.8 },
        { id: "l_s3_esC", from: "s3", to: "esC", rate_mbps: 1000, prop_delay_us: 0.8 }
      ],
      flows: [
        {
          id: "f_ctrl_A_to_B",
          priority: 7,
          payload_bytes: 280,
          period_us: 250,
          deadline_us: 130,
          traffic_type: "control",
          path: ["l_esA_s1", "l_s1_s2", "l_s2_esB"]
        },
        {
          id: "f_sensor_A_to_C",
          priority: 6,
          payload_bytes: 220,
          period_us: 500,
          deadline_us: 180,
          traffic_type: "sensor",
          path: ["l_esA_s1", "l_s1_s2", "l_s2_s3", "l_s3_esC"]
        },
        {
          id: "f_video_A_loop",
          priority: 3,
          payload_bytes: 900,
          period_us: 1000,
          deadline_us: null,
          traffic_type: "video",
          path: ["l_esA_s1", "l_s1_s2", "l_s2_s3", "l_s3_s1"]
        }
      ]
    };

    const inputEl = document.getElementById("input");
    const statusEl = document.getElementById("status");

    document.getElementById("sampleBtn").addEventListener("click", () => {
      inputEl.value = JSON.stringify(sample, null, 2);
      renderInput();
      statusEl.textContent = "Triangle sample loaded";
    });

    document.getElementById("renderBtn").addEventListener("click", renderInput);
    document.getElementById("solveBtn").addEventListener("click", solve);

    inputEl.value = JSON.stringify(sample, null, 2);
    renderInput();

    function round3(v) {
      return Math.round(v * 1000) / 1000;
    }

    function parseModel() {
      const model = JSON.parse(inputEl.value);
      if (!Array.isArray(model.nodes) || !Array.isArray(model.links) || !Array.isArray(model.flows)) {
        throw new Error("nodes/links/flows required");
      }
      return model;
    }

    function estimatePacketCount(model) {
      let count = 0;
      for (const f of model.flows) {
        if (!f.period_us || f.period_us <= 0) throw new Error(`invalid period: ${f.id}`);
        const rep = model.cycle_time_us / f.period_us;
        const r = Math.round(rep);
        if (Math.abs(rep - r) > 1e-9) throw new Error(`cycle_time_us divisible by period_us required (${f.id})`);
        count += r;
      }
      return count;
    }

    function renderInput() {
      try {
        const model = parseModel();
        const packetCount = estimatePacketCount(model);

        document.getElementById("inNodes").textContent = model.nodes.length;
        document.getElementById("inLinks").textContent = model.links.length;
        document.getElementById("inFlows").textContent = model.flows.length;
        document.getElementById("inPkts").textContent = packetCount;

        const topo = document.getElementById("topo");
        topo.innerHTML = "";

        const n = Object.fromEntries(model.nodes.map((x) => [x.id, x]));
        const pushNode = (id) => {
          const d = document.createElement("div");
          const m = n[id] || { id, type: "unknown" };
          d.className = `node ${m.type}`;
          d.textContent = `${m.id} (${m.type})`;
          topo.appendChild(d);
        };
        const pushEdge = (txt) => {
          const d = document.createElement("div");
          d.className = "edge";
          d.textContent = txt;
          topo.appendChild(d);
        };

        pushNode("s1"); pushNode("s2"); pushNode("s3");
        pushEdge("s1 -> s2"); pushEdge("s2 -> s3"); pushEdge("s3 -> s1");
        pushNode("esA"); pushNode("esB"); pushNode("esC");

        statusEl.textContent = "input rendered";
      } catch (e) {
        statusEl.innerHTML = `<span class=\"miss\">input error: ${e.message}</span>`;
      }
    }

    async function solve() {
      try {
        const model = parseModel();
        statusEl.textContent = "solving ILP...";

        const res = await fetch("/api/solve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(model)
        });
        const data = await res.json();
        if (!data.ok) {
          throw new Error(data.error || "solve failed");
        }

        renderResult(model, data.result);
        statusEl.textContent = `done: ${data.result.method}, runtime=${data.result.runtime_ms}ms, vars=${data.result.stats.variables}, bin=${data.result.stats.binaries}`;
      } catch (e) {
        statusEl.innerHTML = `<span class=\"miss\">solve error: ${e.message}</span>`;
      }
    }

    function renderResult(model, result) {
      document.getElementById("mMethod").textContent = result.method;
      document.getElementById("mObj").textContent = result.objective;
      document.getElementById("mUtil").textContent = result.worst_util_percent;
      document.getElementById("mRuntime").textContent = result.runtime_ms;

      const axis = document.getElementById("axis");
      axis.innerHTML = "";
      for (let i = 1; i < 10; i++) {
        const t = document.createElement("div");
        t.className = "tick";
        t.style.left = `${i * 10}%`;
        axis.appendChild(t);
      }
      document.getElementById("axisMax").textContent = `${model.cycle_time_us} us`;

      const gclRows = document.getElementById("gclRows");
      gclRows.innerHTML = "";
      for (const link of model.links) {
        const linkData = result.gcl.links[link.id];
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `<div class=\"title\">${link.id} (${link.from} -> ${link.to})</div><div class=\"bar-area\" id=\"bar-${link.id}\"></div>`;
        gclRows.appendChild(row);

        const area = row.querySelector(`#bar-${link.id}`);
        for (const e of linkData.entries) {
          const cls = e.note.includes("guard") ? "guard" : (e.note.includes("best-effort") ? "remain" : "flow");
          const bar = document.createElement("div");
          bar.className = `bar ${cls}`;
          bar.style.left = `${(e.start_us / model.cycle_time_us) * 100}%`;
          bar.style.width = `${Math.max((e.duration_us / model.cycle_time_us) * 100, 0.7)}%`;
          bar.textContent = `${e.note} (${e.start_us}-${e.end_us})`;
          area.appendChild(bar);
        }
      }

      const packetTable = document.getElementById("packetTable");
      packetTable.innerHTML = "";
      for (const p of result.packetRows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${p.packet_id}</td><td>${p.flow_id}</td><td>${round3(p.release_us)}</td><td>${round3(p.end_us)}</td><td>${round3(p.e2e_delay_us)}</td><td>${p.deadline_abs_us == null ? "-" : round3(p.deadline_abs_us)}</td><td>${p.slack_us == null ? "-" : round3(p.slack_us)}</td><td class=\"${p.status === "OK" || p.status === "BE" ? "ok" : "miss"}\">${p.status}</td>`;
        packetTable.appendChild(tr);
      }

      document.getElementById("jsonOut").textContent = JSON.stringify(result.gcl, null, 2);
    }
  </script>
</body>
</html>
