<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ILP Learning Mode &mdash; TSN/GCL Solver</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ═══════════════════════════════════════════════
       Light Theme Override
       ═══════════════════════════════════════════════ */
    :root {
      --bg: #f8f9fa; --bg2: #f0f2f5;
      --card: #ffffff; --card-hi: #f8fafc;
      --border: rgba(59,130,246,0.2); --border-hi: rgba(59,130,246,0.4);
      --text: #1e293b; --text2: #475569; --text3: #64748b;
      --cyan: #0891b2; --blue: #3B82F6; --purple: #7c3aed;
      --orange: #d97706; --red: #dc2626; --green: #059669; --pink: #db2777;
      --flow-ctrl: #3B82F6; --flow-sensor: #059669; --flow-video: #db2777;
      --guard: #d97706; --be: #e2e8f0;
    }
    body { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%); }
    .bg-grid {
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59,130,246,0.06), transparent),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6,182,212,0.04), transparent),
        linear-gradient(rgba(59,130,246,0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59,130,246,0.06) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      backdrop-filter: blur(20px);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .card:hover { border-color: rgba(59,130,246,0.3); }
    .card-title { color: var(--text2); }
    .card-title::before { background: var(--blue); }
    .metric-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .metric-card::after { background: linear-gradient(90deg, var(--blue), transparent); }
    .metric-val { color: var(--blue); }
    .svg-container { background: rgba(248,250,252,0.8); }
    .tooltip {
      background: rgba(255,255,255,0.97);
      border: 1px solid rgba(59,130,246,0.25);
      color: var(--text); box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .tooltip .tt-title { color: var(--blue); }
    .tooltip .tt-k { color: var(--text3); }
    .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%); color: #fff; }
    .btn-secondary { background: rgba(248,250,252,0.8); color: var(--text); border: 1px solid rgba(59,130,246,0.2); }
    .btn-secondary:hover { border-color: var(--blue); background: #fff; }
    .engine-badge.loading { background: rgba(217,119,6,0.1); color: var(--orange); border: 1px solid rgba(217,119,6,0.2); }
    .engine-badge.ready { background: rgba(5,150,105,0.1); color: var(--green); border: 1px solid rgba(5,150,105,0.2); }
    .spinner { border-color: rgba(59,130,246,0.2); border-top-color: var(--blue); }
    .pkt-table th { border-bottom: 1px solid rgba(59,130,246,0.15); color: var(--text3); }
    .pkt-table td { border-bottom: 1px solid rgba(59,130,246,0.08); }
    .pkt-table tr:hover td { background: rgba(59,130,246,0.04); }
    .topo-link { stroke: rgba(59,130,246,0.25); }
    .auto-desc { background: rgba(255,255,255,0.95); border: 1px solid rgba(59,130,246,0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .auto-desc h3 { color: var(--blue); }
    .auto-domain-legend .domain-tag { border: 1px solid rgba(59,130,246,0.15); background: rgba(255,255,255,0.8); color: var(--text2); }
    pre { background: rgba(248,250,252,0.9); border-color: rgba(59,130,246,0.15); color: var(--text2); }
    textarea { background: rgba(248,250,252,0.9); color: var(--text); border-color: rgba(59,130,246,0.2); }

    /* ── Header ─────────────────────────────────── */
    .keti-header {
      display: flex; align-items: center; justify-content: center;
      gap: 16px; margin-bottom: 8px;
    }
    .keti-header img { height: 40px; width: auto; }
    .keti-header h1 {
      font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;
      background: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }

    /* ── Editable Params ─────────────────────────── */
    .param-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px; margin: 12px 0;
    }
    .param-item {
      display: flex; flex-direction: column; gap: 4px;
    }
    .param-item label {
      font-size: 0.75rem; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .param-item input {
      padding: 6px 10px; border-radius: 6px; border: 1px solid rgba(59,130,246,0.2);
      background: rgba(248,250,252,0.9); font-size: 0.85rem; color: var(--text);
      font-family: 'Courier New', monospace; font-weight: 600;
      transition: border-color 0.2s;
    }
    .param-item input:focus {
      outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
    }
    .param-item .param-unit { font-size: 0.7rem; color: var(--text3); margin-top: 2px; }

    /* ── Editable Flow Table ─────────────────────── */
    .flow-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; margin-top: 10px; }
    .flow-table th {
      text-align: left; padding: 6px 8px; color: var(--text3); font-weight: 600;
      border-bottom: 2px solid rgba(59,130,246,0.2); font-size: 0.72rem;
      text-transform: uppercase; letter-spacing: 0.3px;
    }
    .flow-table td { padding: 4px 6px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .flow-table tr:hover td { background: rgba(59,130,246,0.03); }
    .flow-table input {
      width: 80px; padding: 3px 6px; border-radius: 4px;
      border: 1px solid rgba(59,130,246,0.15); background: #fff;
      font-size: 0.78rem; font-family: 'Courier New', monospace;
      color: var(--text); transition: border-color 0.2s;
    }
    .flow-table input:focus {
      outline: none; border-color: var(--blue); box-shadow: 0 0 0 2px rgba(59,130,246,0.1);
    }
    .flow-table select {
      padding: 3px 6px; border-radius: 4px;
      border: 1px solid rgba(59,130,246,0.15); background: #fff;
      font-size: 0.78rem; color: var(--text);
    }
    .flow-table .computed {
      font-family: 'Courier New', monospace; color: var(--blue); font-weight: 600;
    }
    .flow-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }

    /* ── ILP Formulation Panel ─────────────────── */
    .formulation-panel {
      background: rgba(248,250,252,0.95); border: 1px solid rgba(59,130,246,0.15);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
    }
    .form-section { margin-bottom: 16px; }
    .form-section-title {
      font-size: 0.82rem; font-weight: 700; color: var(--blue);
      margin-bottom: 8px; display: flex; align-items: center; gap: 8px;
    }
    .form-section-title::before {
      content: ''; width: 3px; height: 14px; border-radius: 2px; background: var(--blue);
    }
    .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }
    .form-stat {
      padding: 8px 12px; border-radius: 6px;
      background: rgba(255,255,255,0.9); border: 1px solid rgba(59,130,246,0.1);
    }
    .form-stat .stat-val {
      font-size: 1.1rem; font-weight: 800; color: var(--blue);
      font-family: 'Courier New', monospace;
    }
    .form-stat .stat-label { font-size: 0.7rem; color: var(--text3); margin-top: 2px; }
    .math-block {
      background: rgba(255,255,255,0.9); padding: 10px 14px; border-radius: 6px;
      border: 1px solid rgba(59,130,246,0.1); font-family: 'Courier New', monospace;
      font-size: 0.82rem; color: var(--text); line-height: 1.6; overflow-x: auto;
    }
    .constraint-list {
      list-style: none; padding: 0; margin: 0;
    }
    .constraint-list li {
      padding: 6px 10px; border-radius: 4px; margin-bottom: 4px;
      background: rgba(255,255,255,0.9); border: 1px solid rgba(59,130,246,0.08);
      font-family: 'Courier New', monospace; font-size: 0.78rem;
      color: var(--text2); line-height: 1.5;
    }
    .constraint-list .c-type {
      display: inline-block; padding: 1px 6px; border-radius: 3px;
      font-size: 0.68rem; font-weight: 700; margin-right: 6px;
      text-transform: uppercase;
    }
    .c-bound { background: rgba(59,130,246,0.1); color: var(--blue); }
    .c-chain { background: rgba(5,150,105,0.1); color: var(--green); }
    .c-deadline { background: rgba(220,38,38,0.1); color: var(--red); }
    .c-nonoverlap { background: rgba(124,58,237,0.1); color: var(--purple); }

    .link-contention-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .link-contention-table th {
      text-align: left; padding: 5px 8px; color: var(--text3); font-weight: 600;
      border-bottom: 1px solid rgba(59,130,246,0.15); font-size: 0.72rem;
    }
    .link-contention-table td { padding: 4px 8px; border-bottom: 1px solid rgba(0,0,0,0.04); font-family: 'Courier New', monospace; }

    .compare-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    }
    .compare-box {
      padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.15);
      background: rgba(255,255,255,0.95);
    }
    .compare-box h4 {
      font-size: 0.82rem; font-weight: 700; margin: 0 0 8px;
    }
    .compare-box .cv { font-family: 'Courier New', monospace; font-size: 0.85rem; }
    .compare-greedy h4 { color: var(--orange); }
    .compare-ilp h4 { color: var(--green); }

    /* ── Educational Reference ───────────────────── */
    .edu-panel {
      background: linear-gradient(135deg, rgba(248,250,252,0.95), rgba(255,255,255,0.95));
      border: 1px solid rgba(59,130,246,0.15); border-radius: var(--radius);
      padding: 20px; margin-bottom: 16px;
    }
    .edu-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }
    .edu-item {
      padding: 14px; border-radius: 8px; background: rgba(255,255,255,0.9);
      border: 1px solid rgba(59,130,246,0.1);
    }
    .edu-item h4 {
      font-size: 0.82rem; font-weight: 700; color: var(--blue);
      margin: 0 0 8px; display: flex; align-items: center; gap: 6px;
    }
    .edu-item p {
      font-size: 0.78rem; color: var(--text2); line-height: 1.6; margin: 0;
    }
    .edu-item code {
      background: rgba(59,130,246,0.08); padding: 1px 5px; border-radius: 3px;
      font-size: 0.76rem; color: var(--blue); font-weight: 600;
    }

    /* ── Auto-Solve Toggle ───────────────────────── */
    .auto-solve-toggle {
      display: flex; align-items: center; gap: 8px; font-size: 0.82rem; color: var(--text2);
    }
    .auto-solve-toggle input[type="checkbox"] {
      width: 16px; height: 16px; accent-color: var(--blue);
    }

    /* ── Per-Switch GCL Cards ────────────────────── */
    .gcl-switch-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;
    }
    @media (max-width: 900px) { .gcl-switch-grid { grid-template-columns: 1fr; } }
    .gcl-switch-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      border-radius: var(--radius); padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .gcl-switch-card .sw-header {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 12px; padding-bottom: 8px;
      border-bottom: 1px solid rgba(59,130,246,0.15);
    }
    .sw-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
    .sw-name { font-weight: 700; font-size: 0.95rem; color: var(--text); }
    .sw-chip {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 6px;
      background: rgba(59,130,246,0.1); color: var(--blue); font-weight: 600;
    }
    .sw-stats { margin-left: auto; font-size: 0.75rem; color: var(--text3); }
    .link-label-dir { font-size: 0.8rem; font-weight: 600; color: var(--text2); margin-bottom: 4px; }

    /* ── Per-Packet Detail (collapsible) ──────────── */
    .pkt-detail-grid {
      display: grid; grid-template-columns: 1fr; gap: 6px; max-height: 400px; overflow-y: auto;
    }
    .pkt-detail-item {
      padding: 8px 12px; border-radius: 6px; background: rgba(255,255,255,0.9);
      border: 1px solid rgba(59,130,246,0.08); font-size: 0.76rem;
    }
    .pkt-detail-item .pkt-id { font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .pkt-detail-item .pkt-info { color: var(--text2); font-family: 'Courier New', monospace; line-height: 1.5; }

    /* ── Collapsible overrides ────────────────────── */
    .collapsible { cursor: pointer; user-select: none; }
    .collapsible .arrow {
      display: inline-block; transition: transform 0.3s; font-size: 0.7rem; margin-right: 6px;
    }
    .collapsible.open .arrow { transform: rotate(90deg); }
    .collapse-body { display: none; }
    .collapse-body.show { display: block; }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="wrap">
    <div class="header">
      <div class="keti-header">
        <img src="keti.png" alt="KETI" onerror="this.style.display='none'">
        <h1>ILP Learning Mode</h1>
        <span class="engine-badge loading" id="engineBadge"><span class="spinner"></span>Loading GLPK...</span>
      </div>
      <div class="sub">Parameter Editing + ILP Formulation Visualization &mdash; Educational TSN/GCL Solver</div>
    </div>

    <!-- Educational Reference Panel -->
    <div class="edu-panel">
      <div class="card-title">Reference &mdash; ILP Formulation Basics</div>
      <div class="edu-grid">
        <div class="edu-item">
          <h4>Tx Time Formula</h4>
          <p>
            <code>Tx = (payload + 38) &times; 8 / rate</code><br>
            Ethernet overhead = 38 bytes (7 preamble + 1 SFD + 14 header + 4 FCS + 12 IFG).
            Result in &micro;s when rate is in Mbps.
          </p>
        </div>
        <div class="edu-item">
          <h4>Guard Band</h4>
          <p>
            A small gap (typically 3&micro;s) inserted after each TSN frame transmission.
            Prevents frame interference from clock jitter and switch processing latency.
            Gate closes during guard band &mdash; <code>gate_mask = 00000000</code>.
          </p>
        </div>
        <div class="edu-item">
          <h4>Priority Scheduling</h4>
          <p>
            IEEE 802.1Q defines 8 traffic classes (TC0&ndash;TC7). Higher priority = lower latency.
            LiDAR uses P7 (highest TSN), Radar uses P6.
            Gate mask: one bit per queue, e.g. <code>10000000</code> = TC7 only.
          </p>
        </div>
        <div class="edu-item">
          <h4>Big-M Method</h4>
          <p>
            To model "either A before B or B before A" (disjunctive constraint),
            introduce binary variable <code>y &isin; {0,1}</code> and a large constant M.<br>
            <code>s<sub>B</sub> &ge; s<sub>A</sub> + blk<sub>A</sub> - M&middot;y</code><br>
            <code>s<sub>A</sub> &ge; s<sub>B</sub> + blk<sub>B</sub> - M&middot;(1-y)</code>
          </p>
        </div>
        <div class="edu-item">
          <h4>Link Utilization</h4>
          <p>
            <code>Util = &Sigma;(flow_time + guard_time) / cycle_time &times; 100%</code><br>
            Remaining time is best-effort (BE). Bottleneck link = highest utilization.
            Over 80% utilization may cause deadline misses.
          </p>
        </div>
        <div class="edu-item">
          <h4>Objective Function</h4>
          <p>
            <code>min &Sigma; s<sub>p,last_hop</sub></code> for all TSN packets.<br>
            Minimizing the sum of last-hop start times minimizes total end-to-end delay.
            ILP finds the mathematically optimal schedule; Greedy uses priority heuristics.
          </p>
        </div>
      </div>
    </div>

    <!-- Global Parameters -->
    <div class="card">
      <div class="card-title">Global Parameters (Editable)</div>
      <div class="param-grid">
        <div class="param-item">
          <label>Cycle Time</label>
          <input type="number" id="paramCycleTime" value="10000" min="100" step="100">
          <span class="param-unit">&micro;s &mdash; must be divisible by all flow periods</span>
        </div>
        <div class="param-item">
          <label>Guard Band</label>
          <input type="number" id="paramGuardBand" value="3" min="0" step="1">
          <span class="param-unit">&micro;s &mdash; gap after each TSN frame</span>
        </div>
        <div class="param-item">
          <label>Processing Delay</label>
          <input type="number" id="paramProcDelay" value="3" min="0" step="1">
          <span class="param-unit">&micro;s &mdash; switch forwarding latency per hop</span>
        </div>
      </div>
    </div>

    <!-- Solve Controls -->
    <div class="card" style="padding:12px 20px;">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" id="resolveBtn" disabled>Re-Solve (ILP)</button>
        <button class="btn btn-secondary" id="greedyBtn">Solve (Greedy)</button>
        <button class="btn btn-secondary" id="resetBtn">Reset All</button>
        <div class="auto-solve-toggle">
          <input type="checkbox" id="autoSolve" checked>
          <label for="autoSolve">Auto-solve on edit (Greedy)</label>
        </div>
        <div id="status" style="font-size:0.82rem;"></div>
        <div id="compareBadge" style="display:none;font-size:0.78rem;padding:4px 10px;border-radius:999px;border:1px solid rgba(59,130,246,0.25);background:rgba(59,130,246,0.08);color:var(--blue);"></div>
        <a href="index.html" class="btn btn-secondary" style="margin-left:auto;font-size:0.78rem;">Home</a>
      </div>
    </div>

    <!-- Editable Flow Table -->
    <div class="card">
      <div class="card-title">Flow Specifications (Editable)</div>
      <div style="overflow-x:auto;">
        <table class="flow-table" id="flowTable">
          <thead><tr>
            <th></th>
            <th>Flow ID</th>
            <th>Type</th>
            <th>Payload (B)</th>
            <th>Period (&micro;s)</th>
            <th>Deadline (&micro;s)</th>
            <th>Priority</th>
            <th>Tx Time (&micro;s)</th>
            <th>Pkts/Cycle</th>
          </tr></thead>
          <tbody id="flowTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- ILP Formulation Panel -->
    <div class="card">
      <div class="card-title collapsible open" id="formulationToggle">
        <span class="arrow">&#9654;</span> ILP Formulation Detail
      </div>
      <div class="collapse-body show" id="formulationBody">
        <div class="formulation-panel" id="formulationPanel">
          <div class="form-section">
            <div class="form-section-title">Problem Size</div>
            <div class="form-grid" id="problemSize"></div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Objective Function</div>
            <div class="math-block" id="objectiveDisplay"></div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Constraint Breakdown</div>
            <div class="form-grid" id="constraintBreakdown"></div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Constraint Examples</div>
            <ul class="constraint-list" id="constraintExamples"></ul>
          </div>
          <div class="form-section">
            <div class="form-section-title">Link Contention</div>
            <div style="overflow-x:auto;">
              <table class="link-contention-table" id="linkContentionTable">
                <thead><tr><th>Link</th><th>Packets</th><th>Pairs</th><th>Binary Vars</th><th>Window-Pruned</th></tr></thead>
                <tbody id="linkContentionBody"></tbody>
              </table>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title collapsible" id="pktDetailToggle">
              <span class="arrow">&#9654;</span> Per-Packet Detail
            </div>
            <div class="collapse-body" id="pktDetailBody">
              <div class="pkt-detail-grid" id="pktDetailGrid"></div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-title">Greedy vs ILP Comparison</div>
            <div class="compare-grid" id="compareGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Network Topology -->
    <div class="card">
      <div class="card-title">Network Topology</div>
      <div class="legend" id="topoLegend"></div>
      <div class="svg-container" id="topoContainer" style="height:520px;"></div>
    </div>

    <!-- Metrics -->
    <div class="metrics" id="metricsArea"></div>

    <!-- Per-Switch GCL Detail -->
    <div class="card">
      <div class="card-title">Per-Switch GCL &mdash; Gate Control by Egress Port</div>
    </div>
    <div id="switchGclArea" class="gcl-switch-grid"></div>

    <!-- GCL Gantt -->
    <div class="card">
      <div class="card-title">Per-Link GCL Timeline (Gantt)</div>
      <div class="legend" id="gclLegend"></div>
      <div class="svg-container" id="gclContainer"></div>
    </div>

    <!-- Delay + Utilization -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Packet E2E Delay</div>
        <div class="svg-container" id="delayContainer" style="height:380px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Link Utilization</div>
        <div class="svg-container" id="utilContainer" style="min-height:200px;"></div>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-title">Packet Schedule Table</div>
      <div style="overflow-x:auto;">
        <table class="pkt-table">
          <thead><tr>
            <th>Packet</th><th>Flow</th><th>Route</th><th>Release</th><th>End</th><th>E2E</th><th>Deadline</th><th>Slack</th><th>Status</th>
          </tr></thead>
          <tbody id="pktTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Collapsible JSON Editor -->
    <div class="card">
      <div class="card-title collapsible" id="jsonEditorToggle">
        <span class="arrow">&#9654;</span> Customize Model (JSON)
      </div>
      <div class="collapse-body">
        <textarea id="input" style="min-height:300px;"></textarea>
      </div>
    </div>

    <!-- Raw GCL -->
    <div class="card">
      <div class="card-title collapsible" id="gclJsonToggle">
        <span class="arrow">&#9654;</span> Raw GCL Output (JSON)
      </div>
      <div class="collapse-body">
        <pre id="jsonOut">-</pre>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="vendor/d3.min.js"></script>
  <script type="module">
  import {
    initTooltip, solveGreedy, solveILP, expandPackets,
    renderMetrics, renderTopology, renderGCL, renderDelayChart,
    renderUtilization, renderTable, renderSwitchGCL
  } from './js/ilp-core.js';
  import {
    ROII_REAL_RECONF,
    getReconfPositions, ROII_RECONF_NODE_COLORS,
    ROII_RECONF_SCENARIO,
    realFlowColor, ROII_REAL_SWITCHES
  } from './js/roii-real-data.js?v=4';

  /* ── Helpers (inline copies — no ilp-core.js modification) ── */
  function txTimeUs(bytes, mbps) { return ((bytes + 38) * 8) / mbps; }
  function round3(v) { return Math.round(v * 1000) / 1000; }

  /* ── State ── */
  const ORIGINAL = JSON.parse(JSON.stringify(ROII_REAL_RECONF));
  let editableModel = JSON.parse(JSON.stringify(ORIGINAL));
  let glpk = null;
  let currentModel = null;
  let currentResult = null;
  let greedyResult = null;
  let ilpResult = null;
  let debounceTimer = null;

  const fcopts = { flowColorFn: realFlowColor, beColor: '#e2e8f0', beBorder: 'rgba(59,130,246,0.15)' };

  /* ── DOM Refs ── */
  const statusEl = document.getElementById("status");
  const compareBadgeEl = document.getElementById("compareBadge");
  const resolveBtn = document.getElementById("resolveBtn");
  const greedyBtn = document.getElementById("greedyBtn");
  const resetBtn = document.getElementById("resetBtn");
  const inputEl = document.getElementById("input");
  const autoSolveEl = document.getElementById("autoSolve");

  /* ── Init ── */
  initTooltip();

  // Collapsibles
  function setupCollapsible(toggleId) {
    const el = document.getElementById(toggleId);
    if (!el) return;
    el.addEventListener("click", function() {
      this.classList.toggle("open");
      const body = this.nextElementSibling || this.parentElement.querySelector(".collapse-body");
      if (body) body.classList.toggle("show");
    });
  }
  setupCollapsible("formulationToggle");
  setupCollapsible("jsonEditorToggle");
  setupCollapsible("gclJsonToggle");

  // Per-packet detail toggle
  document.getElementById("pktDetailToggle").addEventListener("click", function() {
    this.classList.toggle("open");
    document.getElementById("pktDetailBody").classList.toggle("show");
  });

  /* ── Build Editable Flow Table ── */
  function buildFlowTable() {
    const tbody = document.getElementById("flowTableBody");
    tbody.innerHTML = "";
    editableModel.flows.forEach((f, i) => {
      const color = realFlowColor(f.id);
      const txUs = round3(txTimeUs(f.payload_bytes, 1000)); // all links 1Gbps
      const pktsPerCycle = editableModel.cycle_time_us / f.period_us;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="flow-dot" style="background:${color}"></span></td>
        <td style="font-weight:600;font-size:0.8rem;">${f.id.replace('f_','')}</td>
        <td>${f.traffic_type}</td>
        <td><input type="number" data-flow="${i}" data-field="payload_bytes" value="${f.payload_bytes}" min="64" step="64"></td>
        <td><input type="number" data-flow="${i}" data-field="period_us" value="${f.period_us}" min="100" step="100"></td>
        <td><input type="number" data-flow="${i}" data-field="deadline_us" value="${f.deadline_us}" min="100" step="100"></td>
        <td>
          <select data-flow="${i}" data-field="priority">
            ${[7,6,5,4,3,2,1,0].map(p => `<option value="${p}" ${p === f.priority ? 'selected' : ''}>P${p}</option>`).join('')}
          </select>
        </td>
        <td class="computed" id="txTime_${i}">${txUs}</td>
        <td class="computed" id="pktsPerCycle_${i}">${pktsPerCycle}</td>
      `;
      tbody.appendChild(tr);
    });

    // Bind input events
    tbody.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("input", onFlowEdit);
    });
  }

  function onFlowEdit(e) {
    const el = e.target;
    const idx = parseInt(el.dataset.flow);
    const field = el.dataset.field;
    const val = field === "priority" ? parseInt(el.value) : parseFloat(el.value);
    if (isNaN(val) || val <= 0) return;

    editableModel.flows[idx][field] = val;

    // Update computed columns
    const txUs = round3(txTimeUs(editableModel.flows[idx].payload_bytes, 1000));
    const pkts = editableModel.cycle_time_us / editableModel.flows[idx].period_us;
    document.getElementById(`txTime_${idx}`).textContent = txUs;
    document.getElementById(`pktsPerCycle_${idx}`).textContent = Number.isInteger(pkts) ? pkts : pkts.toFixed(2);

    scheduleAutoSolve();
  }

  /* ── Global Param Edits ── */
  document.getElementById("paramCycleTime").addEventListener("input", e => {
    const v = parseFloat(e.target.value);
    if (v > 0) { editableModel.cycle_time_us = v; updateComputedColumns(); scheduleAutoSolve(); }
  });
  document.getElementById("paramGuardBand").addEventListener("input", e => {
    const v = parseFloat(e.target.value);
    if (v >= 0) { editableModel.guard_band_us = v; scheduleAutoSolve(); }
  });
  document.getElementById("paramProcDelay").addEventListener("input", e => {
    const v = parseFloat(e.target.value);
    if (v >= 0) { editableModel.processing_delay_us = v; scheduleAutoSolve(); }
  });

  function updateComputedColumns() {
    editableModel.flows.forEach((f, i) => {
      const pkts = editableModel.cycle_time_us / f.period_us;
      const el = document.getElementById(`pktsPerCycle_${i}`);
      if (el) el.textContent = Number.isInteger(pkts) ? pkts : pkts.toFixed(2);
    });
  }

  /* ── Auto-Solve with Debounce ── */
  function scheduleAutoSolve() {
    if (!autoSolveEl.checked) return;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      syncAndSolveGreedy();
    }, 500);
  }

  function syncModelToJSON() {
    inputEl.value = JSON.stringify(editableModel, null, 2);
  }

  /* ── Greedy Solver ── */
  function syncAndSolveGreedy() {
    syncModelToJSON();
    runGreedy();
  }

  function runGreedy() {
    try {
      const model = JSON.parse(inputEl.value);
      const t0 = performance.now();
      const result = solveGreedy(model);
      const wallMs = Math.round(performance.now() - t0);
      currentModel = model;
      currentResult = result;
      greedyResult = result;
      renderAll();
      renderFormulation(model, result);
      statusEl.innerHTML = `<strong style="color:var(--green)">Greedy solved in ${wallMs}ms</strong> &mdash; ${result.packetRows.length} packets`;
      statusEl.className = "status-ok";
      updateCompareBadge();
    } catch (e) {
      statusEl.textContent = "Error: " + e.message;
      statusEl.className = "status-err";
    }
  }

  /* ── ILP Solver ── */
  async function runILPSolve() {
    if (!glpk) { statusEl.textContent = "GLPK not loaded yet"; return; }
    try {
      const model = JSON.parse(inputEl.value);
      resolveBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span>Solving ILP (tmlim=15s)...';
      statusEl.className = "";
      await new Promise(r => setTimeout(r, 50));

      const result = await solveILP(model, glpk, { tmlim: 15 });
      currentModel = model;
      currentResult = result;
      ilpResult = result;
      renderAll();
      renderFormulation(model, result);
      statusEl.innerHTML = `<strong style="color:var(--green)">ILP solved in ${result.stats.runtime_ms}ms</strong> &mdash; ${result.stats.variables} vars, ${result.stats.binaries} bins`;
      statusEl.className = "status-ok";
      updateCompareBadge();
    } catch (e) {
      statusEl.textContent = "ILP failed: " + e.message;
      statusEl.className = "status-err";
    }
    resolveBtn.disabled = false;
  }

  /* ── Compare Badge ── */
  function updateCompareBadge() {
    if (!greedyResult || !ilpResult) {
      compareBadgeEl.style.display = 'none';
      return;
    }
    const gObj = Number(greedyResult.objective || 0);
    const iObj = Number(ilpResult.objective || 0);
    const deltaPct = gObj > 0 ? ((gObj - iObj) / gObj) * 100 : 0;
    const gMiss = greedyResult.packetRows.filter(p => p.status === "MISS").length;
    const iMiss = ilpResult.packetRows.filter(p => p.status === "MISS").length;
    const improved = deltaPct >= 0 && iMiss <= gMiss;

    compareBadgeEl.style.display = 'inline-block';
    compareBadgeEl.style.borderColor = improved ? 'rgba(5,150,105,0.25)' : 'rgba(217,119,6,0.25)';
    compareBadgeEl.style.background = improved ? 'rgba(5,150,105,0.08)' : 'rgba(217,119,6,0.10)';
    compareBadgeEl.style.color = improved ? 'var(--green)' : 'var(--orange)';
    compareBadgeEl.textContent = `ILP vs Greedy: ${deltaPct >= 0 ? '-' : '+'}${Math.abs(deltaPct).toFixed(1)}% objective, MISS ${gMiss}\u2192${iMiss}`;
  }

  /* ── Render All Charts ── */
  function renderAll() {
    if (!currentResult) return;
    const container = document.getElementById("topoContainer");
    const W = container.clientWidth;
    const positions = getReconfPositions(W, 520);

    renderMetrics(currentModel, currentResult);
    renderTopology(currentModel, currentResult, {
      nodePositions: positions,
      nodeColors: ROII_RECONF_NODE_COLORS,
      height: 520
    });
    renderSwitchGCL(currentModel, currentResult, {
      switches: ROII_REAL_SWITCHES,
      flowColorFn: realFlowColor
    });
    renderGCL(currentModel, currentResult, fcopts);
    renderDelayChart(currentModel, currentResult, fcopts);
    renderUtilization(currentModel, currentResult, { beColor: '#e2e8f0' });
    renderTable(currentResult, fcopts);
    document.getElementById("jsonOut").textContent = JSON.stringify(currentResult.gcl, null, 2);
  }

  /* ════════════════════════════════════════════════
     ILP FORMULATION PANEL — Educational Visualization
     ════════════════════════════════════════════════ */
  function renderFormulation(model, result) {
    try {
      const pkts = expandPackets(model);
      renderProblemSize(model, pkts, result);
      renderObjective(pkts);
      renderConstraintBreakdown(model, pkts);
      renderConstraintExamples(model, pkts);
      renderLinkContention(model, pkts);
      renderPktDetail(model, pkts, result);
      renderComparison(result);
    } catch (e) {
      document.getElementById("problemSize").innerHTML = `<div class="form-stat"><div class="stat-val" style="color:var(--red)">Error</div><div class="stat-label">${e.message}</div></div>`;
    }
  }

  function renderProblemSize(model, pkts, result) {
    const el = document.getElementById("problemSize");
    const tsnPkts = pkts.filter(p => p.tsn);
    const totalHops = pkts.reduce((s, p) => s + p.routes[0].hops.length, 0);
    const allSingle = pkts.every(p => p.routes.length === 1);

    // Count non-overlap pairs per link
    let totalBins = 0, totalPairsRaw = 0;
    const lm = new Map(model.links.map(l => [l.id, l]));
    for (const link of model.links) {
      const lo = [];
      pkts.forEach((pk, p) => {
        pk.routes[0].hops.forEach((hp, h) => {
          if (hp.lid === link.id) {
            const blk = hp.tx + (pk.tsn ? model.guard_band_us : 0);
            let earliest = pk.rel;
            for (let hh = 0; hh < h; hh++) {
              earliest += pk.routes[0].hops[hh].tx + pk.routes[0].hops[hh].pd + model.processing_delay_us;
            }
            let latest = model.cycle_time_us - hp.tx;
            lo.push({ p, h, earliest, latest, blk });
          }
        });
      });
      const pairs = lo.length * (lo.length - 1) / 2;
      totalPairsRaw += pairs;
      for (let a = 0; a < lo.length; a++)
        for (let b = a + 1; b < lo.length; b++) {
          const oa = lo[a], ob = lo[b];
          if (oa.latest + oa.blk > ob.earliest && ob.latest + ob.blk > oa.earliest) totalBins++;
        }
    }

    const contVars = totalHops; // s_p_h
    const zVars = allSingle ? 0 : pkts.reduce((s, p) => s + p.routes.length, 0);

    // Constraint counts
    const bounds = totalHops * 2; // lb + ub per hop
    const chains = pkts.reduce((s, p) => s + Math.max(0, p.routes[0].hops.length - 1), 0);
    const deadlines = tsnPkts.length;
    const nonOverlap = totalBins * 2; // two constraints per binary
    const totalConstraints = bounds + chains + deadlines + nonOverlap;

    el.innerHTML = [
      { val: pkts.length, label: 'Total Packets', sub: `${tsnPkts.length} TSN + ${pkts.length - tsnPkts.length} BE` },
      { val: contVars, label: 'Continuous Vars (s)', sub: `s_p_h start times` },
      { val: totalBins, label: 'Binary Vars (y)', sub: `ordering decisions` },
      { val: zVars, label: 'Route Vars (z)', sub: allSingle ? 'all single-route' : 'route selection' },
      { val: totalConstraints, label: 'Total Constraints', sub: `${bounds} bound + ${chains} chain + ${deadlines} dl + ${nonOverlap} non-overlap` },
      { val: result.stats.runtime_ms + 'ms', label: 'Solve Time', sub: result.method.split('(')[0] }
    ].map(s => `<div class="form-stat"><div class="stat-val">${s.val}</div><div class="stat-label">${s.label}</div><div class="stat-label" style="font-size:0.65rem;margin-top:1px;">${s.sub}</div></div>`).join('');
  }

  function renderObjective(pkts) {
    const el = document.getElementById("objectiveDisplay");
    const tsnPkts = pkts.filter(p => p.tsn);
    const terms = tsnPkts.map(p => {
      const lastH = p.routes[0].hops.length - 1;
      return `s<sub>${p.pid.replace('#','_')},${lastH}</sub>`;
    });
    if (terms.length > 6) {
      el.innerHTML = `<strong>min</strong> ${terms.slice(0, 4).join(' + ')} + ... + ${terms.slice(-2).join(' + ')}<br><span style="font-size:0.72rem;color:var(--text3);">(${terms.length} TSN packet last-hop start times)</span>`;
    } else {
      el.innerHTML = `<strong>min</strong> ${terms.join(' + ')}`;
    }
  }

  function renderConstraintBreakdown(model, pkts) {
    const el = document.getElementById("constraintBreakdown");
    const totalHops = pkts.reduce((s, p) => s + p.routes[0].hops.length, 0);
    const chains = pkts.reduce((s, p) => s + Math.max(0, p.routes[0].hops.length - 1), 0);
    const deadlines = pkts.filter(p => p.tsn).length;

    let nonOverlap = 0;
    for (const link of model.links) {
      const lo = [];
      pkts.forEach((pk, p) => {
        pk.routes[0].hops.forEach((hp, h) => {
          if (hp.lid === link.id) {
            const blk = hp.tx + (pk.tsn ? model.guard_band_us : 0);
            let earliest = pk.rel;
            for (let hh = 0; hh < h; hh++)
              earliest += pk.routes[0].hops[hh].tx + pk.routes[0].hops[hh].pd + model.processing_delay_us;
            let latest = model.cycle_time_us - hp.tx;
            lo.push({ earliest, latest, blk });
          }
        });
      });
      for (let a = 0; a < lo.length; a++)
        for (let b = a + 1; b < lo.length; b++)
          if (lo[a].latest + lo[a].blk > lo[b].earliest && lo[b].latest + lo[b].blk > lo[a].earliest) nonOverlap++;
    }

    el.innerHTML = [
      { val: totalHops * 2, label: 'Bound Constraints', cls: 'c-bound', desc: `${totalHops} lower + ${totalHops} upper` },
      { val: chains, label: 'Chain Constraints', cls: 'c-chain', desc: 'hop-to-hop ordering' },
      { val: deadlines, label: 'Deadline Constraints', cls: 'c-deadline', desc: 'TSN packets only' },
      { val: nonOverlap * 2, label: 'Non-Overlap Constraints', cls: 'c-nonoverlap', desc: `${nonOverlap} pairs \u00d7 2` }
    ].map(s => `<div class="form-stat"><div class="stat-val">${s.val}</div><div class="stat-label"><span class="c-type ${s.cls}">${s.label.split(' ')[0]}</span> ${s.label}</div><div class="stat-label" style="font-size:0.65rem;">${s.desc}</div></div>`).join('');
  }

  function renderConstraintExamples(model, pkts) {
    const el = document.getElementById("constraintExamples");
    if (pkts.length === 0) { el.innerHTML = '<li>No packets</li>'; return; }
    const examples = [];
    const lm = new Map(model.links.map(l => [l.id, l]));

    // 1. Lower bound example
    const p0 = pkts[0], h0 = p0.routes[0].hops[0];
    const lb = p0.rel;
    examples.push(`<span class="c-type c-bound">Bound</span> s<sub>${p0.pid.replace('#','_')},0</sub> &ge; ${lb} &micro;s <span style="color:var(--text3)">&mdash; packet release time</span>`);

    // 2. Upper bound example
    const ub = model.cycle_time_us - h0.tx;
    examples.push(`<span class="c-type c-bound">Bound</span> s<sub>${p0.pid.replace('#','_')},0</sub> &le; ${round3(ub)} &micro;s <span style="color:var(--text3)">&mdash; must finish within cycle</span>`);

    // 3. Chain example
    if (p0.routes[0].hops.length > 1) {
      const chainMin = round3(h0.tx + h0.pd + model.processing_delay_us);
      examples.push(`<span class="c-type c-chain">Chain</span> s<sub>${p0.pid.replace('#','_')},1</sub> &ge; s<sub>${p0.pid.replace('#','_')},0</sub> + ${chainMin} &micro;s <span style="color:var(--text3)">&mdash; tx(${round3(h0.tx)}) + prop(${h0.pd}) + proc(${model.processing_delay_us})</span>`);
    }

    // 4. Deadline example
    const tsnPkt = pkts.find(p => p.tsn && p.dl != null);
    if (tsnPkt) {
      const lastH = tsnPkt.routes[0].hops.length - 1;
      const lastHop = tsnPkt.routes[0].hops[lastH];
      const dlBound = round3(tsnPkt.dl - lastHop.tx - lastHop.pd);
      examples.push(`<span class="c-type c-deadline">Deadline</span> s<sub>${tsnPkt.pid.replace('#','_')},${lastH}</sub> &le; ${dlBound} &micro;s <span style="color:var(--text3)">&mdash; dl(${tsnPkt.dl}) - tx(${round3(lastHop.tx)}) - prop(${lastHop.pd})</span>`);
    }

    // 5. Non-overlap example (find first pair on same link)
    outer:
    for (const link of model.links) {
      const ops = [];
      pkts.forEach((pk, pi) => {
        pk.routes[0].hops.forEach((hp, hi) => {
          if (hp.lid === link.id) {
            const blk = round3(hp.tx + (pk.tsn ? model.guard_band_us : 0));
            ops.push({ pi, hi, pid: pk.pid, blk });
          }
        });
      });
      if (ops.length >= 2) {
        const a = ops[0], b = ops[1];
        const linkObj = lm.get(link.id);
        examples.push(`<span class="c-type c-nonoverlap">Non-Overlap</span> On ${linkObj.from}\u2192${linkObj.to}: either s<sub>${b.pid.replace('#','_')},${b.hi}</sub> &ge; s<sub>${a.pid.replace('#','_')},${a.hi}</sub> + ${a.blk} <strong>or</strong> s<sub>${a.pid.replace('#','_')},${a.hi}</sub> &ge; s<sub>${b.pid.replace('#','_')},${b.hi}</sub> + ${b.blk} <span style="color:var(--text3)">&mdash; Big-M with binary y</span>`);
        break;
      }
    }

    el.innerHTML = examples.map(e => `<li>${e}</li>`).join('');
  }

  function renderLinkContention(model, pkts) {
    const tbody = document.getElementById("linkContentionBody");
    const rows = [];
    for (const link of model.links) {
      const ops = [];
      pkts.forEach((pk, p) => {
        pk.routes[0].hops.forEach((hp, h) => {
          if (hp.lid === link.id) {
            const blk = hp.tx + (pk.tsn ? model.guard_band_us : 0);
            let earliest = pk.rel;
            for (let hh = 0; hh < h; hh++)
              earliest += pk.routes[0].hops[hh].tx + pk.routes[0].hops[hh].pd + model.processing_delay_us;
            let latest = model.cycle_time_us - hp.tx;
            ops.push({ earliest, latest, blk });
          }
        });
      });
      if (ops.length < 2) continue;
      const totalPairs = ops.length * (ops.length - 1) / 2;
      let activePairs = 0;
      for (let a = 0; a < ops.length; a++)
        for (let b = a + 1; b < ops.length; b++)
          if (ops[a].latest + ops[a].blk > ops[b].earliest && ops[b].latest + ops[b].blk > ops[a].earliest) activePairs++;
      const pruned = totalPairs - activePairs;
      rows.push({ from: link.from, to: link.to, pkts: ops.length, pairs: totalPairs, bins: activePairs, pruned });
    }
    rows.sort((a, b) => b.bins - a.bins);
    tbody.innerHTML = rows.map(r => `<tr>
      <td>${r.from} \u2192 ${r.to}</td>
      <td>${r.pkts}</td>
      <td>${r.pairs}</td>
      <td style="font-weight:700;color:var(--blue)">${r.bins}</td>
      <td style="color:var(--green)">${r.pruned > 0 ? '-' + r.pruned : '0'}</td>
    </tr>`).join('');
  }

  function renderPktDetail(model, pkts, result) {
    const grid = document.getElementById("pktDetailGrid");
    grid.innerHTML = pkts.map(pk => {
      const rt = pk.routes[0];
      const hopsStr = rt.hops.map((hp, h) => {
        const link = model.links.find(l => l.id === hp.lid);
        return `Hop${h}: ${link.from}\u2192${link.to} (tx=${round3(hp.tx)}\u00b5s, prop=${hp.pd}\u00b5s)`;
      }).join('<br>');

      const pktRow = result.packetRows.find(p => p.packet_id === pk.pid);
      const schedStr = pktRow ? pktRow.hops.map((h, i) =>
        `Hop${i}: start=${h.start_us}\u00b5s, end=${h.end_us}\u00b5s`
      ).join('<br>') : 'not scheduled';

      return `<div class="pkt-detail-item">
        <div class="pkt-id" style="color:${realFlowColor(pk.fid)}">${pk.pid}</div>
        <div class="pkt-info">
          pri=${pk.pri} | rel=${pk.rel}\u00b5s | dl=${pk.dl ?? '\u221e'}\u00b5s | hops=${rt.hops.length}<br>
          ${hopsStr}<br>
          <strong>Schedule:</strong> ${schedStr}
          ${pktRow ? `<br>E2E=${pktRow.e2e_delay_us}\u00b5s | Status=${pktRow.status}` : ''}
        </div>
      </div>`;
    }).join('');
  }

  function renderComparison(currentResult) {
    const grid = document.getElementById("compareGrid");
    const gRes = greedyResult;
    const iRes = ilpResult;

    if (!gRes && !iRes) {
      grid.innerHTML = '<div style="color:var(--text3);font-size:0.82rem;">Solve with both Greedy and ILP to compare.</div>';
      return;
    }

    function statBox(res, label, cls) {
      if (!res) return `<div class="compare-box ${cls}"><h4>${label}</h4><div class="cv" style="color:var(--text3)">Not yet solved</div></div>`;
      const miss = res.packetRows.filter(p => p.status === "MISS").length;
      const overlaps = Number(res.stats?.overlap_conflicts || 0);
      return `<div class="compare-box ${cls}">
        <h4>${label}</h4>
        <div class="cv">Objective: <strong>${res.objective}</strong> \u00b5s</div>
        <div class="cv">Runtime: <strong>${res.stats.runtime_ms}</strong> ms</div>
        <div class="cv">MISS: <strong style="color:${miss > 0 ? 'var(--red)' : 'var(--green)'}">${miss}</strong></div>
        <div class="cv">Overlaps: <strong>${overlaps}</strong></div>
        <div class="cv">Worst Util: <strong>${res.worst_util_percent}%</strong></div>
        <div class="cv" style="font-size:0.72rem;color:var(--text3);margin-top:4px;">${res.method}</div>
      </div>`;
    }

    grid.innerHTML = statBox(gRes, 'Greedy', 'compare-greedy') + statBox(iRes, 'ILP', 'compare-ilp');
  }

  /* ── Reset Button ── */
  resetBtn.addEventListener("click", () => {
    editableModel = JSON.parse(JSON.stringify(ORIGINAL));
    document.getElementById("paramCycleTime").value = ORIGINAL.cycle_time_us;
    document.getElementById("paramGuardBand").value = ORIGINAL.guard_band_us;
    document.getElementById("paramProcDelay").value = ORIGINAL.processing_delay_us;
    greedyResult = null;
    ilpResult = null;
    compareBadgeEl.style.display = 'none';
    buildFlowTable();
    syncAndSolveGreedy();
    statusEl.textContent = "Reset to ROII_REAL_RECONF defaults";
    statusEl.className = "status-ok";
  });

  greedyBtn.addEventListener("click", syncAndSolveGreedy);
  resolveBtn.addEventListener("click", runILPSolve);

  /* ── Responsive ── */
  let resizeTimer;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(renderAll, 300);
  });

  /* ── Initialize ── */
  buildFlowTable();
  const badge = document.getElementById("engineBadge");
  badge.className = "engine-badge ready";
  badge.innerHTML = "&#9679; Greedy Ready";
  resolveBtn.disabled = false;
  syncAndSolveGreedy();

  /* ── Load GLPK/WASM ── */
  (async () => {
    try {
      const GLPK = (await import('./vendor/glpk.js')).default;
      glpk = await GLPK();
      const ver = typeof glpk.version === 'function' ? glpk.version() : (glpk.version || '?');
      badge.innerHTML = `&#9679; GLPK ${ver} + Greedy`;
      resolveBtn.textContent = "Re-Solve (ILP)";
      // Auto-run ILP once GLPK is ready
      await runILPSolve();
    } catch (e) {
      console.warn('GLPK load failed (greedy works):', e);
      resolveBtn.textContent = "Re-Solve (Greedy only)";
    }
  })();
  </script>
</body>
</html>
