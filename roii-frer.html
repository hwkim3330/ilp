<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ROii FRER Demo &mdash; Dual-Path Redundancy</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="bg-grid"></div>
  <div class="wrap">
    <div class="header">
      <h1>ROii FRER Demo</h1>
      <div class="sub">IEEE 802.1CB Frame Replication &amp; Elimination &mdash; Dual-Path Route Selection + GCL Scheduling</div>
      <div style="margin-top:10px;">
        <span class="engine-badge loading" id="engineBadge"><span class="spinner"></span>Loading GLPK/WASM...</span>
      </div>
    </div>

    <!-- Scenario Description -->
    <div class="auto-desc" id="scenarioDesc"></div>

    <!-- Domain Legend -->
    <div class="auto-domain-legend" id="domainLegend"></div>

    <!-- Network Topology -->
    <div class="card">
      <div class="card-title">FRER Network Topology</div>
      <div class="legend" id="topoLegend"></div>
      <div class="svg-container" id="topoContainer" style="height:480px;"></div>
    </div>

    <!-- Metrics -->
    <div class="metrics" id="metricsArea"></div>

    <!-- GCL Gantt -->
    <div class="card">
      <div class="card-title">Per-Link GCL Timeline (Gantt)</div>
      <div class="legend" id="gclLegend"></div>
      <div class="svg-container" id="gclContainer"></div>
    </div>

    <!-- Delay + Utilization -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Packet E2E Delay</div>
        <div class="svg-container" id="delayContainer" style="height:380px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Link Utilization</div>
        <div class="svg-container" id="utilContainer" style="min-height:200px;"></div>
      </div>
    </div>

    <!-- Route Selection Summary -->
    <div class="card">
      <div class="card-title">Route Selection (ILP vs Greedy)</div>
      <div id="routeSelection" style="padding:10px 16px;"></div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="card-title">Packet Schedule Table</div>
      <div style="overflow-x:auto;">
        <table class="pkt-table">
          <thead><tr>
            <th>Packet</th><th>Flow</th><th>Route</th><th>Release</th><th>End</th><th>E2E</th><th>Deadline</th><th>Slack</th><th>Status</th>
          </tr></thead>
          <tbody id="pktTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Collapsible JSON Editor -->
    <div class="card">
      <div class="card-title collapsible" id="jsonEditorToggle">
        <span class="arrow">&#9654;</span> Customize Model (JSON)
      </div>
      <div class="collapse-body">
        <textarea id="input" style="min-height:300px;"></textarea>
        <div class="toolbar">
          <button class="btn btn-secondary" id="resetBtn">Reset to Default</button>
          <button class="btn btn-primary" id="resolveBtn" disabled>Re-Solve</button>
          <div id="status" style="margin-top:0; margin-left:8px;"></div>
        </div>
      </div>
    </div>

    <!-- Raw GCL -->
    <div class="card">
      <div class="card-title collapsible" id="gclJsonToggle">
        <span class="arrow">&#9654;</span> Raw GCL Output (JSON)
      </div>
      <div class="collapse-body">
        <pre id="jsonOut">-</pre>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="vendor/d3.min.js"></script>
  <script type="module">
  import {
    initTooltip, solveGreedy, solveILP, renderMetrics, renderTopology,
    renderGCL, renderDelayChart, renderUtilization, renderTable
  } from './js/ilp-core.js';
  import {
    FRER_MODEL, getFrerPositions,
    FRER_NODE_COLORS, FRER_SCENARIO
  } from './js/roii-frer-data.js';

  /* ── Flow Colors (lidar/radar) ── */
  function frerFlowColor(fid) {
    return fid.toLowerCase().includes('lidar') ? '#10B981' : '#952aff';
  }
  const fcopts = {
    flowColorFn: frerFlowColor,
    beColor: '#e2e8f0',
    beBorder: 'rgba(59,130,246,0.15)'
  };

  /* ── State ───────────────────────────────────── */
  let glpk = null;
  let currentModel = JSON.parse(JSON.stringify(FRER_MODEL));
  let currentResult = null;

  /* ── Init ────────────────────────────────────── */
  initTooltip();

  // Render scenario description
  const descEl = document.getElementById("scenarioDesc");
  descEl.innerHTML = `
    <h3>${FRER_SCENARIO.title}</h3>
    <p>${FRER_SCENARIO.description}</p>
    <ul class="auto-flow-list">
      ${FRER_SCENARIO.flows.map(f => `<li><span class="dot" style="background:${f.color}"></span><strong>${f.name}</strong> &mdash; ${f.desc}</li>`).join("")}
    </ul>
  `;

  // Render domain legend
  const legendEl = document.getElementById("domainLegend");
  legendEl.innerHTML = FRER_SCENARIO.domains.map(d =>
    `<div class="domain-tag"><span class="dsq" style="background:${d.color}"></span>${d.name}</div>`
  ).join("");

  // Collapsibles
  document.getElementById("jsonEditorToggle").addEventListener("click", function() {
    this.classList.toggle("open");
    this.parentElement.querySelector(".collapse-body").classList.toggle("show");
  });
  document.getElementById("gclJsonToggle").addEventListener("click", function() {
    this.classList.toggle("open");
    this.parentElement.querySelector(".collapse-body").classList.toggle("show");
  });

  const inputEl = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const resolveBtn = document.getElementById("resolveBtn");
  const resetBtn = document.getElementById("resetBtn");

  inputEl.value = JSON.stringify(FRER_MODEL, null, 2);

  resetBtn.addEventListener("click", () => {
    inputEl.value = JSON.stringify(FRER_MODEL, null, 2);
    statusEl.textContent = "Reset to default"; statusEl.className = "status-ok";
  });

  resolveBtn.addEventListener("click", runILPSolve);

  function runGreedy() {
    try {
      const model = JSON.parse(inputEl.value);
      const t0 = performance.now();
      const result = solveGreedy(model);
      const wallMs = Math.round(performance.now() - t0);
      currentModel = model;
      currentResult = result;
      renderAll();
      statusEl.innerHTML = `<strong style="color:var(--green)">Greedy solved in ${wallMs}ms</strong>`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "Error: " + e.message;
      statusEl.className = "status-err";
    }
  }

  async function runILPSolve() {
    if (!glpk) { runGreedy(); return; }
    try {
      const model = JSON.parse(inputEl.value);
      resolveBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span>Solving ILP (tmlim=15s)...';
      statusEl.className = "";
      await new Promise(r => setTimeout(r, 50));

      const result = await solveILP(model, glpk, { tmlim: 15 });
      currentModel = model;
      currentResult = result;
      renderAll();
      const label = result.stats.status === 5 ? 'optimal' : 'feasible';
      statusEl.innerHTML = `<strong style="color:var(--green)">ILP ${label} in ${result.stats.runtime_ms}ms</strong> &mdash; ${result.stats.variables} vars, ${result.stats.binaries} bins`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "ILP failed: " + e.message + " — using greedy";
      statusEl.className = "status-err";
      runGreedy();
    }
    resolveBtn.disabled = false;
  }

  function renderRouteSelection() {
    const el = document.getElementById("routeSelection");
    if (!el || !currentResult) return;
    const rows = currentResult.packetRows.filter(p => p.status !== 'BE');
    // Group by flow: show route 0 = SW_FL path, route 1 = SW_FR path
    const flowMap = {};
    for (const r of rows) {
      if (!flowMap[r.flow_id]) flowMap[r.flow_id] = [];
      flowMap[r.flow_id].push(r);
    }
    let html = '<table style="width:100%;border-collapse:collapse;font-size:0.85rem;">';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.1);"><th style="text-align:left;padding:6px;">Flow</th><th>Path</th><th>Hops</th><th>E2E (avg)</th></tr>';
    for (const [fid, pkts] of Object.entries(flowMap)) {
      const routeNums = pkts.map(p => p.selected_route);
      const uniqueRoutes = [...new Set(routeNums)];
      const avgE2e = (pkts.reduce((s, p) => s + p.e2e_delay_us, 0) / pkts.length).toFixed(1);
      const pathLabel = uniqueRoutes.map(r => r === 0 ? 'SW_FL' : 'SW_FR').join(', ');
      const hopsStr = pkts[0].hops.map(h => h.link_id.replace(/^l_/, '').replace(/_/g, ' > ')).join(' ');
      const color = frerFlowColor(fid);
      html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">`;
      html += `<td style="padding:6px;"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};margin-right:6px;vertical-align:middle;"></span>${fid}</td>`;
      html += `<td style="text-align:center;"><strong>${pathLabel}</strong></td>`;
      html += `<td style="text-align:center;font-size:0.75rem;color:var(--text3);">${pkts[0].hops.length} hops</td>`;
      html += `<td style="text-align:center;">${avgE2e} us</td>`;
      html += `</tr>`;
    }
    html += '</table>';
    el.innerHTML = html;
  }

  function renderAll() {
    if (!currentResult) return;
    const container = document.getElementById("topoContainer");
    const W = container.clientWidth;
    const positions = getFrerPositions(W, 480);

    renderMetrics(currentModel, currentResult);
    renderTopology(currentModel, currentResult, {
      nodePositions: positions,
      nodeColors: FRER_NODE_COLORS,
      height: 480
    });
    renderGCL(currentModel, currentResult, fcopts);
    renderDelayChart(currentModel, currentResult, fcopts);
    renderUtilization(currentModel, currentResult, fcopts);
    renderTable(currentResult);
    renderRouteSelection();
    document.getElementById("jsonOut").textContent = JSON.stringify(currentResult.gcl, null, 2);
  }

  // Responsive
  let resizeTimer;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(renderAll, 300);
  });

  /* ── Auto-Solve with Greedy ──────────────────── */
  const badge = document.getElementById("engineBadge");
  badge.className = "engine-badge ready";
  badge.innerHTML = "&#9679; Greedy Ready";
  resolveBtn.disabled = false;
  runGreedy();

  /* ── Load GLPK/WASM in background ─────────────── */
  (async () => {
    try {
      const GLPK = (await import('./vendor/glpk.js')).default;
      glpk = await GLPK();
      const ver = typeof glpk.version === 'function' ? glpk.version() : (glpk.version || '?');
      badge.innerHTML = `&#9679; GLPK ${ver} + Greedy`;
      resolveBtn.textContent = "Re-Solve (ILP)";
    } catch (e) {
      console.warn('GLPK load failed (greedy works):', e);
      resolveBtn.textContent = "Re-Solve (Greedy)";
    }
  })();
  </script>
</body>
</html>
