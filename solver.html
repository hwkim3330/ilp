<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TSN/GCL Universal Solver</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* ═══════════════════════════════════════════════
       Light Theme Override
       ═══════════════════════════════════════════════ */
    :root {
      --bg: #f8f9fa; --bg2: #f0f2f5;
      --card: #ffffff; --card-hi: #f8fafc;
      --border: rgba(59,130,246,0.2); --border-hi: rgba(59,130,246,0.4);
      --text: #1e293b; --text2: #475569; --text3: #64748b;
      --cyan: #0891b2; --blue: #3B82F6; --purple: #7c3aed;
      --orange: #d97706; --red: #dc2626; --green: #059669; --pink: #db2777;
      --flow-ctrl: #3B82F6; --flow-sensor: #059669; --flow-video: #db2777;
      --guard: #d97706; --be: #e2e8f0;
    }
    body { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%); }
    .bg-grid {
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59,130,246,0.06), transparent),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6,182,212,0.04), transparent),
        linear-gradient(rgba(59,130,246,0.06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59,130,246,0.06) 1px, transparent 1px);
      background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
    }
    .card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      backdrop-filter: blur(20px);
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .card:hover { border-color: rgba(59,130,246,0.3); }
    .card-title { color: var(--text2); }
    .card-title::before { background: var(--blue); }
    .metric-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .metric-card::after { background: linear-gradient(90deg, var(--blue), transparent); }
    .metric-val { color: var(--blue); }
    .svg-container { background: rgba(248,250,252,0.8); }
    .tooltip {
      background: rgba(255,255,255,0.97);
      border: 1px solid rgba(59,130,246,0.25);
      color: var(--text); box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }
    .tooltip .tt-title { color: var(--blue); }
    .tooltip .tt-k { color: var(--text3); }
    .btn-primary { background: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%); color: #fff; }
    .btn-secondary { background: rgba(248,250,252,0.8); color: var(--text); border: 1px solid rgba(59,130,246,0.2); }
    .btn-secondary:hover { border-color: var(--blue); background: #fff; }
    .engine-badge.loading { background: rgba(217,119,6,0.1); color: var(--orange); border: 1px solid rgba(217,119,6,0.2); }
    .engine-badge.ready { background: rgba(5,150,105,0.1); color: var(--green); border: 1px solid rgba(5,150,105,0.2); }
    .spinner { border-color: rgba(59,130,246,0.2); border-top-color: var(--blue); }
    .pkt-table th { border-bottom: 1px solid rgba(59,130,246,0.15); color: var(--text3); }
    .pkt-table td { border-bottom: 1px solid rgba(59,130,246,0.08); }
    .pkt-table tr:hover td { background: rgba(59,130,246,0.04); }
    .topo-link { stroke: rgba(59,130,246,0.25); }
    pre { background: rgba(248,250,252,0.9); border-color: rgba(59,130,246,0.15); color: var(--text2); }
    textarea { background: rgba(248,250,252,0.9); color: var(--text); border-color: rgba(59,130,246,0.2); }
    .preview-panel { background: rgba(248,250,252,0.9); border-color: rgba(59,130,246,0.2); }
    .preview-panel .preview-title { color: var(--text3); }
    .preview-flow-table th { color: var(--text3); border-bottom-color: rgba(59,130,246,0.15); }
    .preview-flow-table td { color: var(--text2); border-bottom-color: rgba(59,130,246,0.08); }
    .badge { border-color: rgba(59,130,246,0.2); color: var(--blue); background: rgba(59,130,246,0.06); }

    /* ── Scenario Controls ─────────────────────── */
    .scenario-group { display: flex; gap: 4px; }
    .scenario-btn {
      padding: 5px 14px; border-radius: 6px; font-size: 0.78rem; font-weight: 600;
      border: 1px solid rgba(59,130,246,0.2); background: #fff; color: var(--text2);
      cursor: pointer; transition: all 0.2s;
    }
    .scenario-btn:hover { border-color: var(--blue); color: var(--blue); }
    .scenario-btn.active { background: var(--blue); color: #fff; border-color: var(--blue); }
    .scenario-btn.active.fail { background: var(--red); border-color: var(--red); }
    .failure-banner {
      display: none; padding: 10px 18px; border-radius: 8px; font-size: 0.82rem; font-weight: 600;
      background: rgba(220,38,38,0.08); border: 1px solid rgba(220,38,38,0.25); color: var(--red);
      margin-top: 8px; align-items: center; gap: 8px;
    }
    .failure-banner.show { display: flex; }

    /* ── Link Toggle Chips ─────────────────────── */
    .link-toggles { display: flex; flex-wrap: wrap; gap: 4px; padding: 8px 0 4px; }
    .link-chip {
      padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;
      border: 1px solid rgba(59,130,246,0.25); background: rgba(59,130,246,0.06);
      color: var(--blue); cursor: pointer; transition: all 0.2s; user-select: none;
    }
    .link-chip:hover { border-color: var(--blue); background: rgba(59,130,246,0.12); }
    .link-chip.disabled {
      background: rgba(220,38,38,0.06); border-color: rgba(220,38,38,0.3);
      color: var(--red); text-decoration: line-through;
    }
    .link-chip.disabled:hover { background: rgba(220,38,38,0.12); }

    /* ── Header ─────────────────────────────────── */
    .keti-header {
      display: flex; align-items: center; justify-content: center;
      gap: 16px; margin-bottom: 8px;
    }
    .keti-header img { height: 40px; width: auto; }
    .keti-header h1 {
      font-size: 2rem; font-weight: 800; letter-spacing: -0.02em;
      background: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }

    /* ── Preset Buttons ────────────────────────── */
    .preset-group { display: flex; gap: 6px; justify-content: center; margin: 10px 0 6px; flex-wrap: wrap; }
    .preset-btn {
      padding: 6px 18px; border-radius: 8px; font-size: 0.82rem; font-weight: 700;
      border: 1px solid rgba(59,130,246,0.25); background: #fff; color: var(--text2);
      cursor: pointer; transition: all 0.2s;
    }
    .preset-btn:hover { border-color: var(--blue); color: var(--blue); }
    .preset-btn.active {
      background: linear-gradient(135deg, #3B82F6 0%, #06B6D4 100%);
      color: #fff; border-color: transparent;
    }

    /* ── Scenario Desc & Domain Legend ──────────── */
    .auto-desc {
      background: rgba(255,255,255,0.95); border: 1px solid rgba(59,130,246,0.15);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .auto-desc h3 { color: var(--blue); }
    .auto-domain-legend .domain-tag {
      border: 1px solid rgba(59,130,246,0.15); background: rgba(255,255,255,0.8); color: var(--text2);
    }

    /* ── Per-Switch GCL Cards ──────────────────── */
    .gcl-switch-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;
    }
    @media (max-width: 900px) { .gcl-switch-grid { grid-template-columns: 1fr; } }
    .gcl-switch-card {
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(59,130,246,0.15);
      border-radius: var(--radius); padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .gcl-switch-card .sw-header {
      display: flex; align-items: center; gap: 10px;
      margin-bottom: 12px; padding-bottom: 8px;
      border-bottom: 1px solid rgba(59,130,246,0.15);
    }
    .sw-dot { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }
    .sw-name { font-weight: 700; font-size: 0.95rem; color: var(--text); }
    .sw-chip {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 6px;
      background: rgba(59,130,246,0.1); color: var(--blue); font-weight: 600;
    }
    .sw-stats { margin-left: auto; font-size: 0.75rem; color: var(--text3); }
    .gcl-entry-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
    .gcl-entry-table th {
      text-align: left; padding: 4px 8px; color: var(--text3);
      border-bottom: 1px solid rgba(59,130,246,0.15); font-weight: 600;
    }
    .gcl-entry-table td { padding: 4px 8px; border-bottom: 1px solid rgba(0,0,0,0.06); }
    .gcl-entry-table tr:hover td { background: rgba(0,0,0,0.03); }
    .gate-mask {
      font-family: 'Courier New', monospace; font-size: 0.75rem;
      letter-spacing: 1px; font-weight: 700;
    }
    .gate-open  { color: var(--green); }
    .gate-guard { color: var(--orange); }
    .gate-closed { color: var(--text3); opacity: 0.5; }
    .entry-bar { height: 6px; border-radius: 3px; margin-top: 2px; }
    .link-label-dir { font-size: 0.8rem; font-weight: 600; color: var(--text2); margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="wrap">
    <div class="header">
      <div class="keti-header">
        <img src="keti.png" alt="KETI" onerror="this.style.display='none'">
        <h1>TSN / GCL Universal Solver</h1>
        <span class="engine-badge loading" id="engineBadge"><span class="spinner"></span>Loading GLPK...</span>
      </div>
      <div class="sub">IEEE 802.1Qbv Time-Aware Shaper &mdash; Integer Linear Programming Optimization</div>
      <div class="badge" id="badgeInfo">8 Presets &bull; Multi-Flow Scheduling &bull; Per-Switch GCL &bull; k-Path Routing</div>

      <!-- Preset Buttons -->
      <div class="preset-group" id="presetGroup">
        <button class="preset-btn active" data-preset="roii">ROii Shuttle</button>
        <button class="preset-btn" data-preset="frer">FRER Multi-Path</button>
        <button class="preset-btn" data-preset="automotive">Automotive</button>
        <button class="preset-btn" data-preset="real_gcd">Real GCD 10ms</button>
        <button class="preset-btn" data-preset="real_lcm">Real LCM 100ms</button>
        <button class="preset-btn" data-preset="reconf_gcd">Reconf GCD</button>
        <button class="preset-btn" data-preset="reconf_lcm">Reconf LCM</button>
        <button class="preset-btn" data-preset="sample">Sample</button>
      </div>
    </div>

    <!-- Scenario Description (hidden for Sample) -->
    <div class="auto-desc" id="scenarioDesc" style="display:none;"></div>
    <div class="auto-domain-legend" id="domainLegend" style="display:none;"></div>

    <!-- Input: two-column (textarea + preview) -->
    <div class="card">
      <div class="card-title">Input Model &amp; Solver</div>
      <div class="input-split">
        <div>
          <textarea id="input" style="min-height:400px;"></textarea>
          <div class="toolbar">
            <button class="btn btn-primary" id="solveBtn" disabled>Solve ILP</button>
            <div class="scenario-group" id="scenarioGroup"></div>
            <div id="status" style="margin-top:0; margin-left:8px;"><span class="spinner"></span>Initializing...</div>
          </div>
          <div class="failure-banner" id="failureBanner">
            <span>&#9888;</span> <span id="failureText"></span>
          </div>
        </div>
        <div class="preview-panel" id="previewPanel">
          <div class="preview-title">Input Preview</div>
          <div id="previewContent" style="color:var(--text3);font-size:0.8rem;">Edit JSON to see topology preview...</div>
        </div>
      </div>
    </div>

    <!-- Metrics -->
    <div class="metrics" id="metricsArea"></div>

    <!-- Topology + Delay -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Network Topology</div>
        <div class="legend" id="topoLegend"></div>
        <div class="link-toggles" id="linkToggles"></div>
        <div class="svg-container" id="topoContainer" style="height:520px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Packet E2E Delay</div>
        <div class="svg-container" id="delayContainer" style="height:380px;"></div>
      </div>
    </div>

    <!-- Per-Switch GCL Detail -->
    <div class="card" id="switchGclCard" style="display:none;">
      <div class="card-title">Per-Switch GCL &mdash; Gate Control by Egress Port</div>
    </div>
    <div id="switchGclArea" class="gcl-switch-grid"></div>

    <!-- GCL Gantt -->
    <div class="card">
      <div class="card-title">Per-Link GCL Timeline (Gantt)</div>
      <div class="legend" id="gclLegend"></div>
      <div class="svg-container" id="gclContainer"></div>
    </div>

    <!-- Utilization + Table -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Link Utilization</div>
        <div class="svg-container" id="utilContainer" style="min-height:200px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Packet Schedule Table</div>
        <div style="overflow-x:auto;">
          <table class="pkt-table">
            <thead><tr>
              <th>Packet</th><th>Flow</th><th>Route</th><th>Release</th><th>End</th><th>E2E</th><th>Deadline</th><th>Slack</th><th>Status</th>
            </tr></thead>
            <tbody id="pktTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Raw GCL JSON -->
    <div class="card">
      <div class="card-title collapsible" id="gclJsonToggle">
        <span class="arrow">&#9654;</span> Raw GCL Output (JSON)
      </div>
      <div class="collapse-body">
        <pre id="jsonOut">-</pre>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="vendor/d3.min.js"></script>
  <script type="module">
  import {
    initTooltip, solveGreedy, solveILP, flowColor, renderMetrics, renderTopology,
    renderGCL, renderDelayChart, renderUtilization, renderTable,
    renderInputPreview, renderSwitchGCL
  } from './js/ilp-core.js';
  import { ROII_MODEL, getRoiiPositions, ROII_NODE_COLORS, ROII_SCENARIO, ROII_SWITCHES } from './js/roii-data.js';
  import { FRER_MODEL, getFrerPositions, FRER_NODE_COLORS, FRER_SCENARIO, FRER_SWITCHES } from './js/roii-frer-data.js?v=2';
  import { AUTOMOTIVE_MODEL, getAutomotivePositions, AUTOMOTIVE_NODE_COLORS, SCENARIO_DESC, AUTOMOTIVE_SWITCHES, automotiveFlowColor } from './js/automotive-data.js';
  import {
    ROII_REAL_GCD, ROII_REAL_LCM, getRealPositions,
    ROII_REAL_NODE_COLORS, ROII_REAL_SWITCHES,
    ROII_REAL_GCD_SCENARIO, ROII_REAL_LCM_SCENARIO, realFlowColor,
    ROII_REAL_RECONF_GCD, ROII_REAL_RECONF_LCM,
    getReconfPositions, ROII_RECONF_NODE_COLORS,
    ROII_RECONF_GCD_SCENARIO, ROII_RECONF_LCM_SCENARIO
  } from './js/roii-real-data.js?v=2';

  /* ── ROii Flow Colors ── */
  function roiiFlowColor(fid) {
    const id = (fid || '').toLowerCase();
    if (id.includes('lidar')) return '#10B981';
    if (id.includes('radar')) return '#952aff';
    return '#3B82F6';
  }

  /* ── Sample Data ─────────────────────────────── */
  const SAMPLE = {
    cycle_time_us: 1000, guard_band_us: 3, processing_delay_us: 3,
    nodes: [
      { id: "esA", type: "endstation" }, { id: "esB", type: "endstation" },
      { id: "esC", type: "endstation" }, { id: "s1", type: "switch" },
      { id: "s2", type: "switch" }, { id: "s3", type: "switch" }
    ],
    links: [
      { id: "l_esA_s1", from: "esA", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s1_s2", from: "s1", to: "s2", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_s1", from: "s2", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_s3", from: "s2", to: "s3", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_s2", from: "s3", to: "s2", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_s1", from: "s3", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s1_s3", from: "s1", to: "s3", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_esB", from: "s2", to: "esB", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_esC", from: "s3", to: "esC", rate_mbps: 1000, prop_delay_us: 0.8 }
    ],
    flows: [
      { id: "f_ctrl_A_to_B", priority: 7, payload_bytes: 280, period_us: 250, deadline_us: 130, traffic_type: "control", src: "esA", dst: "esB", k_paths: 3 },
      { id: "f_sensor_A_to_C", priority: 6, payload_bytes: 220, period_us: 500, deadline_us: 180, traffic_type: "sensor", src: "esA", dst: "esC", k_paths: 3 },
      { id: "f_video_A_loop", priority: 3, payload_bytes: 900, period_us: 1000, deadline_us: null, traffic_type: "video", src: "esA", dst: "s1", k_paths: 4 }
    ]
  };

  /* ── Preset Registry ─────────────────────────── */
  const PRESETS = {
    roii: {
      label: "ROii Shuttle", model: ROII_MODEL,
      getPositions: getRoiiPositions, nodeColors: ROII_NODE_COLORS,
      scenario: ROII_SCENARIO, switches: ROII_SWITCHES,
      flowColorFn: roiiFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR", "SW_REAR"]
    },
    frer: {
      label: "FRER Multi-Path", model: FRER_MODEL,
      getPositions: getFrerPositions, nodeColors: FRER_NODE_COLORS,
      scenario: FRER_SCENARIO, switches: FRER_SWITCHES,
      flowColorFn: roiiFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR"]
    },
    automotive: {
      label: "Automotive", model: AUTOMOTIVE_MODEL,
      getPositions: getAutomotivePositions, nodeColors: AUTOMOTIVE_NODE_COLORS,
      scenario: SCENARIO_DESC, switches: AUTOMOTIVE_SWITCHES,
      flowColorFn: automotiveFlowColor, topoHeight: 420,
      failNodes: ["GATEWAY", "SW1"]
    },
    real_gcd: {
      label: "Real GCD 10ms", model: ROII_REAL_GCD,
      getPositions: getRealPositions, nodeColors: ROII_REAL_NODE_COLORS,
      scenario: ROII_REAL_GCD_SCENARIO, switches: ROII_REAL_SWITCHES,
      flowColorFn: realFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR", "SW_REAR"]
    },
    real_lcm: {
      label: "Real LCM 100ms", model: ROII_REAL_LCM,
      getPositions: getRealPositions, nodeColors: ROII_REAL_NODE_COLORS,
      scenario: ROII_REAL_LCM_SCENARIO, switches: ROII_REAL_SWITCHES,
      flowColorFn: realFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR", "SW_REAR"]
    },
    reconf_gcd: {
      label: "Reconf GCD", model: ROII_REAL_RECONF_GCD,
      getPositions: getReconfPositions, nodeColors: ROII_RECONF_NODE_COLORS,
      scenario: ROII_RECONF_GCD_SCENARIO, switches: ROII_REAL_SWITCHES,
      flowColorFn: realFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR", "SW_REAR"]
    },
    reconf_lcm: {
      label: "Reconf LCM", model: ROII_REAL_RECONF_LCM,
      getPositions: getReconfPositions, nodeColors: ROII_RECONF_NODE_COLORS,
      scenario: ROII_RECONF_LCM_SCENARIO, switches: ROII_REAL_SWITCHES,
      flowColorFn: realFlowColor, topoHeight: 520,
      failNodes: ["SW_FL", "SW_FR", "SW_REAR"]
    },
    sample: {
      label: "Sample", model: SAMPLE,
      getPositions: null, nodeColors: null,
      scenario: null, switches: [],
      flowColorFn: null, topoHeight: 380,
      failNodes: ["s1", "s2", "s3"]
    }
  };

  /* ── State ───────────────────────────────────── */
  let glpk = null;
  let currentPresetKey = 'roii';
  let currentPreset = PRESETS.roii;
  let currentScenario = 'normal';
  let disabledLinks = new Set();
  let currentModel = null;
  let currentResult = null;

  /* ── Build Model with Failures ── */
  function buildModel() {
    const m = JSON.parse(JSON.stringify(currentPreset.model));
    m.links = m.links.filter(l => !disabledLinks.has(l.id));
    return m;
  }

  /* ── Init ────────────────────────────────────── */
  initTooltip();

  // Collapsible
  document.getElementById("gclJsonToggle").addEventListener("click", function() {
    this.classList.toggle("open");
    this.parentElement.querySelector(".collapse-body").classList.toggle("show");
  });

  const inputEl = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const solveBtn = document.getElementById("solveBtn");

  /* ── Input Preview (debounced) ───────────────── */
  let previewTimer;
  inputEl.addEventListener("input", () => {
    clearTimeout(previewTimer);
    previewTimer = setTimeout(updatePreview, 300);
  });

  function updatePreview() {
    try {
      const model = JSON.parse(inputEl.value);
      renderInputPreview(model, "previewContent");
    } catch {
      document.getElementById("previewContent").innerHTML =
        '<div style="color:var(--text3);font-size:0.8rem;padding:10px;">Invalid JSON...</div>';
    }
  }

  /* ── Preset Switching ────────────────────────── */
  function switchPreset(key) {
    currentPresetKey = key;
    currentPreset = PRESETS[key];
    currentScenario = 'normal';
    disabledLinks.clear();

    // Update preset buttons
    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.preset === key);
    });

    // Rebuild scenario buttons
    rebuildScenarioButtons();

    // Render scenario description
    renderScenarioDesc();

    // Set topo height
    document.getElementById("topoContainer").style.height = currentPreset.topoHeight + "px";

    // Show/hide switch GCL card
    document.getElementById("switchGclCard").style.display = currentPreset.switches.length ? '' : 'none';

    // Load model
    const model = buildModel();
    inputEl.value = JSON.stringify(model, null, 2);
    updatePreview();
    renderLinkToggles();
    runGreedy();
  }

  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', () => switchPreset(btn.dataset.preset));
  });

  /* ── Scenario Description ────────────────────── */
  function renderScenarioDesc() {
    const descEl = document.getElementById("scenarioDesc");
    const legendEl = document.getElementById("domainLegend");
    const sc = currentPreset.scenario;

    if (!sc) {
      descEl.style.display = 'none';
      legendEl.style.display = 'none';
      return;
    }

    descEl.style.display = '';
    legendEl.style.display = '';
    descEl.innerHTML = `
      <h3>${sc.title}</h3>
      <p>${sc.description}</p>
      <ul class="auto-flow-list">
        ${sc.flows.map(f => `<li><span class="dot" style="background:${f.color}"></span><strong>${f.name}</strong> &mdash; ${f.desc}</li>`).join("")}
      </ul>
    `;
    legendEl.innerHTML = sc.domains.map(d =>
      `<div class="domain-tag"><span class="dsq" style="background:${d.color}"></span>${d.name}</div>`
    ).join("");
  }

  /* ── Dynamic Scenario/Failure Buttons ────────── */
  function rebuildScenarioButtons() {
    const group = document.getElementById("scenarioGroup");
    group.innerHTML = '';

    // Normal button
    const normalBtn = document.createElement("button");
    normalBtn.className = "scenario-btn active";
    normalBtn.dataset.scenario = "normal";
    normalBtn.textContent = "Normal";
    group.appendChild(normalBtn);

    // Failure buttons
    currentPreset.failNodes.forEach(node => {
      const btn = document.createElement("button");
      btn.className = "scenario-btn";
      btn.dataset.scenario = `fail-${node}`;
      btn.textContent = `${node} Fail`;
      group.appendChild(btn);
    });

    // Attach handlers
    group.querySelectorAll('.scenario-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        currentScenario = btn.dataset.scenario;
        disabledLinks.clear();
        if (currentScenario !== 'normal') {
          const failNode = currentScenario.replace('fail-', '');
          currentPreset.model.links.forEach(l => {
            if (l.from === failNode || l.to === failNode) disabledLinks.add(l.id);
          });
        }
        updateScenarioUI();
        const model = buildModel();
        inputEl.value = JSON.stringify(model, null, 2);
        updatePreview();
        renderLinkToggles();
        runGreedy();
      });
    });
  }

  /* ── Scenario UI ── */
  const failureBanner = document.getElementById("failureBanner");
  const failureText = document.getElementById("failureText");

  function updateScenarioUI() {
    document.querySelectorAll('#scenarioGroup .scenario-btn').forEach(btn => {
      const s = btn.dataset.scenario;
      btn.classList.toggle('active', s === currentScenario);
      btn.classList.toggle('fail', s === currentScenario && currentScenario !== 'normal');
    });
    if (currentScenario !== 'normal') {
      const failNode = currentScenario.replace('fail-', '');
      failureBanner.classList.add('show');
      failureText.textContent = `${failNode} offline \u2014 ${disabledLinks.size} links removed, traffic rerouted`;
    } else {
      failureBanner.classList.remove('show');
    }
  }

  /* ── Link Toggle Chips ── */
  function renderLinkToggles() {
    const el = document.getElementById("linkToggles");
    el.innerHTML = "";
    currentPreset.model.links.forEach(l => {
      const chip = document.createElement("span");
      chip.className = "link-chip" + (disabledLinks.has(l.id) ? " disabled" : "");
      chip.textContent = `${l.from}\u2192${l.to}`;
      chip.title = l.id;
      chip.addEventListener("click", () => {
        if (disabledLinks.has(l.id)) disabledLinks.delete(l.id);
        else disabledLinks.add(l.id);
        currentScenario = disabledLinks.size === 0 ? 'normal' : 'custom';
        document.querySelectorAll('#scenarioGroup .scenario-btn').forEach(b => {
          b.classList.remove('active', 'fail');
          if (b.dataset.scenario === 'normal' && currentScenario === 'normal') b.classList.add('active');
        });
        if (disabledLinks.size > 0) {
          failureBanner.classList.add('show');
          failureText.textContent = `${disabledLinks.size} link(s) disabled \u2014 traffic rerouted`;
        } else {
          failureBanner.classList.remove('show');
        }
        renderLinkToggles();
        const model = buildModel();
        inputEl.value = JSON.stringify(model, null, 2);
        updatePreview();
        runGreedy();
      });
      el.appendChild(chip);
    });
  }

  /* ── Solve Button ── */
  solveBtn.addEventListener("click", runILPSolve);

  function runGreedy() {
    try {
      const model = JSON.parse(inputEl.value);
      const t0 = performance.now();
      const result = solveGreedy(model);
      const wallMs = Math.round(performance.now() - t0);
      currentModel = model;
      currentResult = result;
      renderAll();
      statusEl.innerHTML = `<strong style="color:var(--green)">Greedy solved in ${wallMs}ms</strong>`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "Error: " + e.message;
      statusEl.className = "status-err";
    }
  }

  async function runILPSolve() {
    if (!glpk) { runGreedy(); return; }
    try {
      const model = JSON.parse(inputEl.value);
      solveBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span>Solving ILP (tmlim=15s)...';
      statusEl.className = "";
      await new Promise(r => setTimeout(r, 50));

      const result = await solveILP(model, glpk, { tmlim: 15 });
      currentModel = model;
      currentResult = result;
      renderAll();
      statusEl.textContent = `ILP solved in ${result.stats.runtime_ms}ms | ${result.stats.variables} vars, ${result.stats.binaries} bins`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "ILP failed: " + e.message + " — using greedy";
      statusEl.className = "status-err";
      runGreedy();
    }
    solveBtn.disabled = false;
  }

  function renderAll() {
    if (!currentResult) return;

    const container = document.getElementById("topoContainer");
    const W = container.clientWidth;
    const H = currentPreset.topoHeight;
    const positions = currentPreset.getPositions ? currentPreset.getPositions(W, H) : null;

    const colorFn = currentPreset.flowColorFn || flowColor;
    const fcopts = { flowColorFn: colorFn, beColor: '#e2e8f0', beBorder: 'rgba(59,130,246,0.15)' };

    renderMetrics(currentModel, currentResult);
    renderTopology(currentModel, currentResult, {
      nodePositions: positions,
      nodeColors: currentPreset.nodeColors,
      height: H
    });
    if (currentPreset.switches.length) {
      document.getElementById("switchGclCard").style.display = '';
      renderSwitchGCL(currentModel, currentResult, {
        switches: currentPreset.switches,
        flowColorFn: colorFn
      });
    } else {
      document.getElementById("switchGclCard").style.display = 'none';
      document.getElementById("switchGclArea").innerHTML = '';
    }
    renderGCL(currentModel, currentResult, fcopts);
    renderDelayChart(currentModel, currentResult, fcopts);
    renderUtilization(currentModel, currentResult, { beColor: '#e2e8f0' });
    renderTable(currentResult, fcopts);
    document.getElementById("jsonOut").textContent = JSON.stringify(currentResult.gcl, null, 2);
  }

  // Responsive
  let resizeTimer;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => { renderAll(); updatePreview(); }, 300);
  });

  /* ── Initialize with ROii preset ─────────────── */
  rebuildScenarioButtons();
  renderScenarioDesc();
  document.getElementById("topoContainer").style.height = currentPreset.topoHeight + "px";
  document.getElementById("switchGclCard").style.display = currentPreset.switches.length ? '' : 'none';
  const model = buildModel();
  inputEl.value = JSON.stringify(model, null, 2);
  updatePreview();
  renderLinkToggles();

  const badge = document.getElementById("engineBadge");
  badge.className = "engine-badge ready";
  badge.innerHTML = "&#9679; Greedy Ready";
  solveBtn.disabled = false;
  runGreedy();

  /* ── Load GLPK/WASM in background ─────────────── */
  (async () => {
    try {
      const GLPK = (await import('./vendor/glpk.js')).default;
      glpk = await GLPK();
      const ver = typeof glpk.version === 'function' ? glpk.version() : (glpk.version || '?');
      badge.innerHTML = `&#9679; GLPK ${ver} + Greedy`;
      solveBtn.textContent = "Solve (ILP)";
    } catch (e) {
      console.warn('GLPK load failed (greedy works):', e);
      solveBtn.textContent = "Solve (Greedy)";
    }
  })();
  </script>
</body>
</html>
