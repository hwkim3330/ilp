<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TSN/GCL ILP Solver</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="bg-grid"></div>
  <div class="wrap">
    <div class="header">
      <h1>TSN / GCL ILP Solver</h1>
      <div class="sub">IEEE 802.1Qbv Time-Aware Shaper &mdash; Integer Linear Programming Optimization</div>
      <div class="badge" id="badgeInfo">Generic Topology &bull; Multi-Flow Scheduling &bull; k-Path Routing</div>
      <div style="margin-top:10px;">
        <span class="engine-badge loading" id="engineBadge"><span class="spinner"></span>Loading GLPK/WASM...</span>
      </div>
    </div>

    <!-- Input: two-column (textarea + preview) -->
    <div class="card">
      <div class="card-title">Input Model &amp; Solver</div>
      <div class="input-split">
        <div>
          <textarea id="input" style="min-height:400px;"></textarea>
          <div class="toolbar">
            <button class="btn btn-secondary" id="sampleBtn">Load Sample</button>
            <button class="btn btn-primary" id="solveBtn" disabled>Solve ILP</button>
            <div id="status" style="margin-top:0; margin-left:8px;"><span class="spinner"></span>Initializing GLPK engine...</div>
          </div>
        </div>
        <div class="preview-panel" id="previewPanel">
          <div class="preview-title">Input Preview</div>
          <div id="previewContent" style="color:var(--text3);font-size:0.8rem;">Edit JSON to see topology preview...</div>
        </div>
      </div>
    </div>

    <!-- Metrics -->
    <div class="metrics" id="metricsArea"></div>

    <!-- Topology + Delay -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Network Topology</div>
        <div class="legend" id="topoLegend"></div>
        <div class="svg-container" id="topoContainer" style="height:380px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Packet E2E Delay</div>
        <div class="svg-container" id="delayContainer" style="height:380px;"></div>
      </div>
    </div>

    <!-- GCL Gantt -->
    <div class="card">
      <div class="card-title">Per-Link GCL Timeline (Gantt)</div>
      <div class="legend" id="gclLegend"></div>
      <div class="svg-container" id="gclContainer"></div>
    </div>

    <!-- Utilization + Table -->
    <div class="two-col">
      <div class="card">
        <div class="card-title">Link Utilization</div>
        <div class="svg-container" id="utilContainer" style="min-height:200px;"></div>
      </div>
      <div class="card">
        <div class="card-title">Packet Schedule Table</div>
        <div style="overflow-x:auto;">
          <table class="pkt-table">
            <thead><tr>
              <th>Packet</th><th>Flow</th><th>Route</th><th>Release</th><th>End</th><th>E2E</th><th>Deadline</th><th>Slack</th><th>Status</th>
            </tr></thead>
            <tbody id="pktTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Raw GCL JSON -->
    <div class="card">
      <div class="card-title collapsible" id="gclJsonToggle">
        <span class="arrow">&#9654;</span> Raw GCL Output (JSON)
      </div>
      <div class="collapse-body">
        <pre id="jsonOut">-</pre>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="vendor/d3.min.js"></script>
  <script type="module">
  import {
    initTooltip, solveGreedy, solveILP, renderMetrics, renderTopology,
    renderGCL, renderDelayChart, renderUtilization, renderTable,
    renderInputPreview
  } from './js/ilp-core.js';

  /* ── Sample Data ─────────────────────────────── */
  const SAMPLE = {
    cycle_time_us: 1000, guard_band_us: 3, processing_delay_us: 3,
    nodes: [
      { id: "esA", type: "endstation" }, { id: "esB", type: "endstation" },
      { id: "esC", type: "endstation" }, { id: "s1", type: "switch" },
      { id: "s2", type: "switch" }, { id: "s3", type: "switch" }
    ],
    links: [
      { id: "l_esA_s1", from: "esA", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s1_s2", from: "s1", to: "s2", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_s1", from: "s2", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_s3", from: "s2", to: "s3", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_s2", from: "s3", to: "s2", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_s1", from: "s3", to: "s1", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s1_s3", from: "s1", to: "s3", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s2_esB", from: "s2", to: "esB", rate_mbps: 1000, prop_delay_us: 0.8 },
      { id: "l_s3_esC", from: "s3", to: "esC", rate_mbps: 1000, prop_delay_us: 0.8 }
    ],
    flows: [
      { id: "f_ctrl_A_to_B", priority: 7, payload_bytes: 280, period_us: 250, deadline_us: 130, traffic_type: "control", src: "esA", dst: "esB", k_paths: 3 },
      { id: "f_sensor_A_to_C", priority: 6, payload_bytes: 220, period_us: 500, deadline_us: 180, traffic_type: "sensor", src: "esA", dst: "esC", k_paths: 3 },
      { id: "f_video_A_loop", priority: 3, payload_bytes: 900, period_us: 1000, deadline_us: null, traffic_type: "video", src: "esA", dst: "s1", k_paths: 4 }
    ]
  };

  const DEMO_RESULT = {"method":"ILP(GLPK, Route+Schedule)","objective":89.44,"worst_util_percent":3.381,"packetRows":[{"packet_id":"f_sensor_A_to_C#0","flow_id":"f_sensor_A_to_C","priority":6,"selected_route":0,"release_us":0,"end_us":12.592,"e2e_delay_us":12.592,"deadline_abs_us":180,"slack_us":167.408,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":0,"end_us":2.064,"duration_us":2.064},{"link_id":"l_s1_s3","start_us":4.864,"end_us":6.928,"duration_us":2.064},{"link_id":"l_s3_esC","start_us":9.728,"end_us":11.792,"duration_us":2.064}]},{"packet_id":"f_video_A_loop#0","flow_id":"f_video_A_loop","priority":3,"selected_route":0,"release_us":0,"end_us":16.912,"e2e_delay_us":16.912,"deadline_abs_us":null,"slack_us":null,"status":"BE","hops":[{"link_id":"l_esA_s1","start_us":8.608,"end_us":16.112,"duration_us":7.504}]},{"packet_id":"f_ctrl_A_to_B#0","flow_id":"f_ctrl_A_to_B","priority":7,"selected_route":0,"release_us":0,"end_us":18.096,"e2e_delay_us":18.096,"deadline_abs_us":130,"slack_us":111.904,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":4.064,"end_us":6.608,"duration_us":2.544},{"link_id":"l_s1_s2","start_us":9.408,"end_us":11.952,"duration_us":2.544},{"link_id":"l_s2_esB","start_us":14.752,"end_us":17.296,"duration_us":2.544}]},{"packet_id":"f_ctrl_A_to_B#1","flow_id":"f_ctrl_A_to_B","priority":7,"selected_route":0,"release_us":250,"end_us":264.032,"e2e_delay_us":14.032,"deadline_abs_us":380,"slack_us":115.968,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":250,"end_us":252.544,"duration_us":2.544},{"link_id":"l_s1_s2","start_us":255.344,"end_us":257.888,"duration_us":2.544},{"link_id":"l_s2_esB","start_us":260.688,"end_us":263.232,"duration_us":2.544}]},{"packet_id":"f_sensor_A_to_C#1","flow_id":"f_sensor_A_to_C","priority":6,"selected_route":0,"release_us":500,"end_us":512.592,"e2e_delay_us":12.592,"deadline_abs_us":680,"slack_us":167.408,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":500,"end_us":502.064,"duration_us":2.064},{"link_id":"l_s1_s3","start_us":504.864,"end_us":506.928,"duration_us":2.064},{"link_id":"l_s3_esC","start_us":509.728,"end_us":511.792,"duration_us":2.064}]},{"packet_id":"f_ctrl_A_to_B#2","flow_id":"f_ctrl_A_to_B","priority":7,"selected_route":0,"release_us":500,"end_us":518.096,"e2e_delay_us":18.096,"deadline_abs_us":630,"slack_us":111.904,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":504.064,"end_us":506.608,"duration_us":2.544},{"link_id":"l_s1_s2","start_us":509.408,"end_us":511.952,"duration_us":2.544},{"link_id":"l_s2_esB","start_us":514.752,"end_us":517.296,"duration_us":2.544}]},{"packet_id":"f_ctrl_A_to_B#3","flow_id":"f_ctrl_A_to_B","priority":7,"selected_route":0,"release_us":750,"end_us":764.032,"e2e_delay_us":14.032,"deadline_abs_us":880,"slack_us":115.968,"status":"OK","hops":[{"link_id":"l_esA_s1","start_us":750,"end_us":752.544,"duration_us":2.544},{"link_id":"l_s1_s2","start_us":755.344,"end_us":757.888,"duration_us":2.544},{"link_id":"l_s2_esB","start_us":760.688,"end_us":763.232,"duration_us":2.544}]}],"gcl":{"cycle_time_us":1000,"base_time_us":0,"links":{"l_esA_s1":{"from":"esA","to":"s1","entries":[{"index":0,"gate_mask":"01000000","start_us":0,"end_us":2.064,"duration_us":2.064,"note":"f_sensor_A_to_C#0"},{"index":1,"gate_mask":"00000000","start_us":2.064,"end_us":4.064,"duration_us":2,"note":"guard band"},{"index":2,"gate_mask":"10000000","start_us":4.064,"end_us":6.608,"duration_us":2.544,"note":"f_ctrl_A_to_B#0"},{"index":3,"gate_mask":"00000000","start_us":6.608,"end_us":8.608,"duration_us":2,"note":"guard band"},{"index":4,"gate_mask":"00001000","start_us":8.608,"end_us":16.112,"duration_us":7.504,"note":"f_video_A_loop#0"},{"index":5,"gate_mask":"00001111","start_us":16.112,"end_us":250,"duration_us":233.888,"note":"best-effort gap"},{"index":6,"gate_mask":"10000000","start_us":250,"end_us":252.544,"duration_us":2.544,"note":"f_ctrl_A_to_B#1"},{"index":7,"gate_mask":"00000000","start_us":252.544,"end_us":254.544,"duration_us":2,"note":"guard band"},{"index":8,"gate_mask":"00001111","start_us":254.544,"end_us":500,"duration_us":245.456,"note":"best-effort gap"},{"index":9,"gate_mask":"01000000","start_us":500,"end_us":502.064,"duration_us":2.064,"note":"f_sensor_A_to_C#1"},{"index":10,"gate_mask":"00000000","start_us":502.064,"end_us":504.064,"duration_us":2,"note":"guard band"},{"index":11,"gate_mask":"10000000","start_us":504.064,"end_us":506.608,"duration_us":2.544,"note":"f_ctrl_A_to_B#2"},{"index":12,"gate_mask":"00000000","start_us":506.608,"end_us":508.608,"duration_us":2,"note":"guard band"},{"index":13,"gate_mask":"00001111","start_us":508.608,"end_us":750,"duration_us":241.392,"note":"best-effort gap"},{"index":14,"gate_mask":"10000000","start_us":750,"end_us":752.544,"duration_us":2.544,"note":"f_ctrl_A_to_B#3"},{"index":15,"gate_mask":"00000000","start_us":752.544,"end_us":754.544,"duration_us":2,"note":"guard band"},{"index":16,"gate_mask":"00001111","start_us":754.544,"end_us":1000,"duration_us":245.456,"note":"best-effort remainder"}]},"l_s1_s2":{"from":"s1","to":"s2","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":9.408,"duration_us":9.408,"note":"best-effort gap"},{"index":1,"gate_mask":"10000000","start_us":9.408,"end_us":11.952,"duration_us":2.544,"note":"f_ctrl_A_to_B#0"},{"index":2,"gate_mask":"00000000","start_us":11.952,"end_us":13.952,"duration_us":2,"note":"guard band"},{"index":3,"gate_mask":"00001111","start_us":13.952,"end_us":255.344,"duration_us":241.392,"note":"best-effort gap"},{"index":4,"gate_mask":"10000000","start_us":255.344,"end_us":257.888,"duration_us":2.544,"note":"f_ctrl_A_to_B#1"},{"index":5,"gate_mask":"00000000","start_us":257.888,"end_us":259.888,"duration_us":2,"note":"guard band"},{"index":6,"gate_mask":"00001111","start_us":259.888,"end_us":509.408,"duration_us":249.52,"note":"best-effort gap"},{"index":7,"gate_mask":"10000000","start_us":509.408,"end_us":511.952,"duration_us":2.544,"note":"f_ctrl_A_to_B#2"},{"index":8,"gate_mask":"00000000","start_us":511.952,"end_us":513.952,"duration_us":2,"note":"guard band"},{"index":9,"gate_mask":"00001111","start_us":513.952,"end_us":755.344,"duration_us":241.392,"note":"best-effort gap"},{"index":10,"gate_mask":"10000000","start_us":755.344,"end_us":757.888,"duration_us":2.544,"note":"f_ctrl_A_to_B#3"},{"index":11,"gate_mask":"00000000","start_us":757.888,"end_us":759.888,"duration_us":2,"note":"guard band"},{"index":12,"gate_mask":"00001111","start_us":759.888,"end_us":1000,"duration_us":240.112,"note":"best-effort remainder"}]},"l_s2_s1":{"from":"s2","to":"s1","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":1000,"duration_us":1000,"note":"best-effort remainder"}]},"l_s2_s3":{"from":"s2","to":"s3","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":1000,"duration_us":1000,"note":"best-effort remainder"}]},"l_s3_s2":{"from":"s3","to":"s2","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":1000,"duration_us":1000,"note":"best-effort remainder"}]},"l_s3_s1":{"from":"s3","to":"s1","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":1000,"duration_us":1000,"note":"best-effort remainder"}]},"l_s1_s3":{"from":"s1","to":"s3","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":4.864,"duration_us":4.864,"note":"best-effort gap"},{"index":1,"gate_mask":"01000000","start_us":4.864,"end_us":6.928,"duration_us":2.064,"note":"f_sensor_A_to_C#0"},{"index":2,"gate_mask":"00000000","start_us":6.928,"end_us":8.928,"duration_us":2,"note":"guard band"},{"index":3,"gate_mask":"00001111","start_us":8.928,"end_us":504.864,"duration_us":495.936,"note":"best-effort gap"},{"index":4,"gate_mask":"01000000","start_us":504.864,"end_us":506.928,"duration_us":2.064,"note":"f_sensor_A_to_C#1"},{"index":5,"gate_mask":"00000000","start_us":506.928,"end_us":508.928,"duration_us":2,"note":"guard band"},{"index":6,"gate_mask":"00001111","start_us":508.928,"end_us":1000,"duration_us":491.072,"note":"best-effort remainder"}]},"l_s2_esB":{"from":"s2","to":"esB","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":14.752,"duration_us":14.752,"note":"best-effort gap"},{"index":1,"gate_mask":"10000000","start_us":14.752,"end_us":17.296,"duration_us":2.544,"note":"f_ctrl_A_to_B#0"},{"index":2,"gate_mask":"00000000","start_us":17.296,"end_us":19.296,"duration_us":2,"note":"guard band"},{"index":3,"gate_mask":"00001111","start_us":19.296,"end_us":260.688,"duration_us":241.392,"note":"best-effort gap"},{"index":4,"gate_mask":"10000000","start_us":260.688,"end_us":263.232,"duration_us":2.544,"note":"f_ctrl_A_to_B#1"},{"index":5,"gate_mask":"00000000","start_us":263.232,"end_us":265.232,"duration_us":2,"note":"guard band"},{"index":6,"gate_mask":"00001111","start_us":265.232,"end_us":514.752,"duration_us":249.52,"note":"best-effort gap"},{"index":7,"gate_mask":"10000000","start_us":514.752,"end_us":517.296,"duration_us":2.544,"note":"f_ctrl_A_to_B#2"},{"index":8,"gate_mask":"00000000","start_us":517.296,"end_us":519.296,"duration_us":2,"note":"guard band"},{"index":9,"gate_mask":"00001111","start_us":519.296,"end_us":760.688,"duration_us":241.392,"note":"best-effort gap"},{"index":10,"gate_mask":"10000000","start_us":760.688,"end_us":763.232,"duration_us":2.544,"note":"f_ctrl_A_to_B#3"},{"index":11,"gate_mask":"00000000","start_us":763.232,"end_us":765.232,"duration_us":2,"note":"guard band"},{"index":12,"gate_mask":"00001111","start_us":765.232,"end_us":1000,"duration_us":234.768,"note":"best-effort remainder"}]},"l_s3_esC":{"from":"s3","to":"esC","entries":[{"index":0,"gate_mask":"00001111","start_us":0,"end_us":9.728,"duration_us":9.728,"note":"best-effort gap"},{"index":1,"gate_mask":"01000000","start_us":9.728,"end_us":11.792,"duration_us":2.064,"note":"f_sensor_A_to_C#0"},{"index":2,"gate_mask":"00000000","start_us":11.792,"end_us":13.792,"duration_us":2,"note":"guard band"},{"index":3,"gate_mask":"00001111","start_us":13.792,"end_us":509.728,"duration_us":495.936,"note":"best-effort gap"},{"index":4,"gate_mask":"01000000","start_us":509.728,"end_us":511.792,"duration_us":2.064,"note":"f_sensor_A_to_C#1"},{"index":5,"gate_mask":"00000000","start_us":511.792,"end_us":513.792,"duration_us":2,"note":"guard band"},{"index":6,"gate_mask":"00001111","start_us":513.792,"end_us":1000,"duration_us":486.208,"note":"best-effort remainder"}]}}},"stats":{"constraints":433,"variables":205,"binaries":162,"status":5},"runtime_ms":1854};

  /* ── State ───────────────────────────────────── */
  let glpk = null;
  let currentModel = SAMPLE;
  let currentResult = DEMO_RESULT;

  /* ── Init ────────────────────────────────────── */
  initTooltip();

  // Collapsible
  document.getElementById("gclJsonToggle").addEventListener("click", function() {
    this.classList.toggle("open");
    this.parentElement.querySelector(".collapse-body").classList.toggle("show");
  });

  const inputEl = document.getElementById("input");
  const statusEl = document.getElementById("status");
  const solveBtn = document.getElementById("solveBtn");
  const sampleBtn = document.getElementById("sampleBtn");

  /* ── Input Preview (debounced) ───────────────── */
  let previewTimer;
  inputEl.addEventListener("input", () => {
    clearTimeout(previewTimer);
    previewTimer = setTimeout(updatePreview, 300);
  });

  function updatePreview() {
    try {
      const model = JSON.parse(inputEl.value);
      renderInputPreview(model, "previewContent");
    } catch {
      document.getElementById("previewContent").innerHTML =
        '<div style="color:var(--text3);font-size:0.8rem;padding:10px;">Invalid JSON...</div>';
    }
  }

  /* ── Buttons ─────────────────────────────────── */
  sampleBtn.addEventListener("click", () => {
    inputEl.value = JSON.stringify(SAMPLE, null, 2);
    statusEl.textContent = "Sample loaded"; statusEl.className = "status-ok";
    updatePreview();
  });

  solveBtn.addEventListener("click", runILPSolve);

  function runGreedy() {
    try {
      const model = JSON.parse(inputEl.value);
      const t0 = performance.now();
      const result = solveGreedy(model);
      const wallMs = Math.round(performance.now() - t0);
      currentModel = model;
      currentResult = result;
      renderAll();
      statusEl.innerHTML = `<strong style="color:var(--green)">Greedy solved in ${wallMs}ms</strong>`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "Error: " + e.message;
      statusEl.className = "status-err";
    }
  }

  async function runILPSolve() {
    if (!glpk) { runGreedy(); return; }
    try {
      const model = JSON.parse(inputEl.value);
      solveBtn.disabled = true;
      statusEl.innerHTML = '<span class="spinner"></span>Solving ILP (tmlim=15s)...';
      statusEl.className = "";
      await new Promise(r => setTimeout(r, 50));

      const result = await solveILP(model, glpk, { tmlim: 15 });
      currentModel = model;
      currentResult = result;
      renderAll();
      statusEl.textContent = `ILP solved in ${result.stats.runtime_ms}ms | ${result.stats.variables} vars, ${result.stats.binaries} bins`;
      statusEl.className = "status-ok";
    } catch (e) {
      statusEl.textContent = "ILP failed: " + e.message + " — using greedy";
      statusEl.className = "status-err";
      runGreedy();
    }
    solveBtn.disabled = false;
  }

  function renderAll() {
    renderMetrics(currentModel, currentResult);
    renderTopology(currentModel, currentResult);
    renderGCL(currentModel, currentResult);
    renderDelayChart(currentModel, currentResult);
    renderUtilization(currentModel, currentResult);
    renderTable(currentResult);
    document.getElementById("jsonOut").textContent = JSON.stringify(currentResult.gcl, null, 2);
  }

  // Init display
  inputEl.value = JSON.stringify(SAMPLE, null, 2);
  renderAll();
  updatePreview();

  // Responsive
  let resizeTimer;
  window.addEventListener("resize", () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => { renderAll(); updatePreview(); }, 300);
  });

  /* ── Auto-Solve with Greedy ──────────────────── */
  const badge = document.getElementById("engineBadge");
  badge.className = "engine-badge ready";
  badge.innerHTML = "&#9679; Greedy Ready";
  solveBtn.disabled = false;
  runGreedy();

  /* ── Load GLPK/WASM in background ─────────────── */
  (async () => {
    try {
      const GLPK = (await import('./vendor/glpk.js')).default;
      glpk = await GLPK();
      const ver = typeof glpk.version === 'function' ? glpk.version() : (glpk.version || '?');
      badge.innerHTML = `&#9679; GLPK ${ver} + Greedy`;
      solveBtn.textContent = "Solve (ILP)";
    } catch (e) {
      console.warn('GLPK load failed (greedy works):', e);
      solveBtn.textContent = "Solve (Greedy)";
    }
  })();
  </script>
</body>
</html>
